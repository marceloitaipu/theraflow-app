<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TheraFlow - Financeiro</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        body { background: #f5f5f5; padding-bottom: 80px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; }
        .header h1 { font-size: 1.5em; margin-bottom: 15px; }
        .month-selector {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.2); padding: 10px 15px; border-radius: 10px;
        }
        .month-selector button { background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; }
        .month-selector span { font-weight: 600; }
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .summary-card { background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; }
        .summary-total { text-align: center; margin-bottom: 25px; }
        .summary-total .label { font-size: 0.9em; color: #666; margin-bottom: 8px; }
        .summary-total .value { font-size: 3em; font-weight: bold; color: #10b981; }
        .summary-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .summary-item { text-align: center; padding: 15px; background: #f9f9f9; border-radius: 10px; }
        .summary-item .label { font-size: 0.85em; color: #666; margin-bottom: 8px; }
        .summary-item .value { font-size: 1.5em; font-weight: bold; }
        .summary-item .value.green { color: #10b981; }
        .summary-item .value.orange { color: #f59e0b; }
        .summary-item .value.purple { color: #667eea; }
        .summary-item .value.blue { color: #3b82f6; }
        
        /* Resumo Inteligente */
        .smart-summary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; }
        .smart-summary-title { font-size: 1.1em; margin-bottom: 15px; opacity: 0.95; }
        .smart-summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .smart-summary-item { text-align: center; background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px; }
        .smart-summary-item .icon { font-size: 1.5em; margin-bottom: 8px; }
        .smart-summary-item .value { font-size: 1.4em; font-weight: bold; }
        .smart-summary-item .label { font-size: 0.8em; opacity: 0.9; margin-top: 5px; }
        
        /* Pacotes */
        .packages-section { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; }
        .package-card { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 15px; border-radius: 12px; margin-bottom: 12px; }
        .package-card .client-name { font-weight: 600; margin-bottom: 8px; }
        .package-card .progress-bar { background: rgba(255,255,255,0.3); height: 8px; border-radius: 4px; margin: 10px 0; }
        .package-card .progress-fill { background: white; height: 100%; border-radius: 4px; transition: width 0.3s; }
        .package-card .package-info { display: flex; justify-content: space-between; font-size: 0.9em; opacity: 0.95; }
        .package-alert { background: #fef3c7; color: #92400e; padding: 10px 15px; border-radius: 8px; font-size: 0.9em; margin-top: 10px; }
        
        /* Bot√µes de a√ß√£o */
        .action-buttons { display: flex; gap: 10px; margin-bottom: 20px; }
        .action-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 0.9em; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .action-btn.primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .action-btn.secondary { background: #f0f0f0; color: #333; }
        .section { margin-bottom: 30px; }
        .section-title { font-size: 1.2em; margin-bottom: 15px; color: #333; display: flex; justify-content: space-between; align-items: center; }
        .section-title .count { font-size: 0.75em; color: #999; font-weight: normal; background: #f0f0f0; padding: 4px 10px; border-radius: 10px; }
        .payment-card {
            background: white; padding: 15px; border-radius: 12px; margin-bottom: 12px;
            cursor: pointer; transition: all 0.2s; border-left: 4px solid #f59e0b;
        }
        .payment-card:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .payment-card.paid { border-left-color: #10b981; cursor: default; }
        .payment-card .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .payment-card .client { font-weight: 600; color: #333; }
        .payment-card .pay-value { font-size: 1.2em; font-weight: bold; color: #f59e0b; }
        .payment-card.paid .pay-value { color: #10b981; }
        .payment-card .details { font-size: 0.9em; color: #666; }
        .status-badge { display: inline-block; padding: 3px 8px; border-radius: 10px; font-size: 0.75em; font-weight: 600; background: #d1fae5; color: #065f46; margin-left: 8px; }
        .empty-state { text-align: center; padding: 40px; color: #999; }
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-around; padding: 12px 0; z-index: 100;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #999; text-decoration: none; font-size: 0.75em; }
        .nav-item.active { color: #667eea; }
        .nav-item .icon { font-size: 1.8em; margin-bottom: 3px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Financeiro</h1>
        <div class="month-selector">
            <button onclick="changeMonth(-1)">‚óÄ</button>
            <span id="currentMonth">Janeiro 2026</span>
            <button onclick="changeMonth(1)">‚ñ∂</button>
        </div>
    </div>

    <div class="container">
        <!-- Resumo Financeiro Inteligente -->
        <div class="smart-summary">
            <div class="smart-summary-title">üìä Resumo Financeiro Inteligente</div>
            <div class="smart-summary-grid">
                <div class="smart-summary-item">
                    <div class="icon">üí∞</div>
                    <div class="value" id="smartReceived">R$ 0</div>
                    <div class="label">Recebido este m√™s</div>
                </div>
                <div class="smart-summary-item">
                    <div class="icon">‚è≥</div>
                    <div class="value" id="smartPending">R$ 0</div>
                    <div class="label">Pendente</div>
                </div>
                <div class="smart-summary-item">
                    <div class="icon">üìÖ</div>
                    <div class="value" id="smartNext7Days">R$ 0</div>
                    <div class="label">Pr√≥ximos 7 dias</div>
                </div>
            </div>
        </div>

        <!-- Pacotes de Sess√µes -->
        <div class="packages-section" id="packagesSection">
            <h2 class="section-title">üì¶ Pacotes de Sess√µes <span class="count" id="packagesCount">0</span></h2>
            <div id="packagesList"></div>
            <button class="action-btn primary" style="width: 100%; margin-top: 15px;" onclick="showAddPackageModal()">
                + Novo Pacote
            </button>
        </div>

        <!-- Bot√µes de A√ß√£o -->
        <div class="action-buttons">
            <button class="action-btn secondary" onclick="showExportModal()">üìÑ Exportar Relat√≥rio</button>
        </div>

        <div class="summary-card">
            <div class="summary-total">
                <div class="label">Total do M√™s</div>
                <div class="value" id="totalValue">R$ 0</div>
            </div>
            <div class="summary-grid">
                <div class="summary-item"><div class="label">‚úì Recebido</div><div class="value green" id="receivedValue">R$ 0</div></div>
                <div class="summary-item"><div class="label">‚è≥ Pendente</div><div class="value orange" id="pendingValue">R$ 0</div></div>
                <div class="summary-item"><div class="label">üìÖ Sess√µes</div><div class="value purple" id="sessionsCount">0</div></div>
                <div class="summary-item"><div class="label">üìä Ticket M√©dio</div><div class="value purple" id="averageValue">R$ 0</div></div>
            </div>
        </div>

        <div class="section" id="pendingSection">
            <h2 class="section-title">Pagamentos Pendentes <span class="count" id="pendingCount">0</span></h2>
            <div id="pendingList"></div>
        </div>

        <div class="section" id="paidSection">
            <h2 class="section-title">Pagamentos Recebidos <span class="count" id="paidCount">0</span></h2>
            <div id="paidList"></div>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="app.html" class="nav-item"><span class="icon">üè†</span><span>In√≠cio</span></a>
        <a href="clientes.html" class="nav-item"><span class="icon">üë•</span><span>Clientes</span></a>
        <a href="agenda.html" class="nav-item"><span class="icon">üìÖ</span><span>Agenda</span></a>
        <a href="financeiro.html" class="nav-item active"><span class="icon">üí∞</span><span>Financeiro</span></a>
        <a href="perfil.html" class="nav-item"><span class="icon">üë§</span><span>Perfil</span></a>
    </nav>

    <script src="js/data.js"></script>
    <script src="js/ui.js"></script>
    <script>
        if (!TheraFlowData.isLoggedIn()) { window.location.href = 'index.html'; }

        var currentYear = new Date().getFullYear();
        var currentMonth = new Date().getMonth() + 1;

        var meses = ['', 'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 12) { currentMonth = 1; currentYear++; }
            if (currentMonth < 1) { currentMonth = 12; currentYear--; }
            loadFinanceData();
        }

        function loadFinanceData() {
            document.getElementById('currentMonth').textContent = meses[currentMonth] + ' ' + currentYear;
            
            var report = TheraFlowData.getFinanceReport(currentYear, currentMonth);
            
            document.getElementById('totalValue').textContent = TheraFlowUI.formatCurrency(report.total);
            document.getElementById('receivedValue').textContent = TheraFlowUI.formatCurrency(report.totalReceived);
            document.getElementById('pendingValue').textContent = TheraFlowUI.formatCurrency(report.totalPending);
            document.getElementById('sessionsCount').textContent = report.totalSessions;
            document.getElementById('averageValue').textContent = report.totalSessions > 0 
                ? TheraFlowUI.formatCurrency(report.total / report.totalSessions) : 'R$ 0';

            // Buscar sess√µes do m√™s
            var monthStr = currentYear + '-' + String(currentMonth).padStart(2, '0');
            var allSessions = TheraFlowData.getSessions();
            var monthSessions = [];
            var pendingSessions = [];
            var paidSessions = [];
            
            for (var i = 0; i < allSessions.length; i++) {
                var s = allSessions[i];
                if (s.data && s.data.indexOf(monthStr) === 0) {
                    monthSessions.push(s);
                    if (s.pagamento === 'pendente') {
                        pendingSessions.push(s);
                    } else if (s.pagamento === 'pago') {
                        paidSessions.push(s);
                    }
                }
            }

            document.getElementById('pendingCount').textContent = pendingSessions.length;
            document.getElementById('paidCount').textContent = paidSessions.length;

            // Renderizar pendentes
            var pendingList = document.getElementById('pendingList');
            if (pendingSessions.length === 0) {
                pendingList.innerHTML = '<div class="empty-state">üéâ Nenhum pagamento pendente!</div>';
            } else {
                var pendingHtml = '';
                for (var j = 0; j < pendingSessions.length; j++) {
                    var ps = pendingSessions[j];
                    pendingHtml += '<div class="payment-card" onclick="confirmPayment(' + ps.id + ')">' +
                        '<div class="header-row">' +
                            '<span class="client">' + ps.clienteNome + '</span>' +
                            '<span class="pay-value">' + TheraFlowUI.formatCurrency(ps.valor) + '</span>' +
                        '</div>' +
                        '<div class="details">' + TheraFlowUI.formatDateBR(ps.data) + ' ‚Ä¢ ' + ps.tipo + '</div>' +
                    '</div>';
                }
                pendingList.innerHTML = pendingHtml;
            }

            // Renderizar pagos
            var paidList = document.getElementById('paidList');
            if (paidSessions.length === 0) {
                paidList.innerHTML = '<div class="empty-state">Nenhum pagamento recebido neste m√™s</div>';
            } else {
                var paidHtml = '';
                for (var k = 0; k < paidSessions.length; k++) {
                    var pds = paidSessions[k];
                    paidHtml += '<div class="payment-card paid">' +
                        '<div class="header-row">' +
                            '<span class="client">' + pds.clienteNome + ' <span class="status-badge">‚úì Pago</span></span>' +
                            '<span class="pay-value">' + TheraFlowUI.formatCurrency(pds.valor) + '</span>' +
                        '</div>' +
                        '<div class="details">' + TheraFlowUI.formatDateBR(pds.data) + ' ‚Ä¢ ' + pds.tipo + '</div>' +
                    '</div>';
                }
                paidList.innerHTML = paidHtml;
            }
        }

        function confirmPayment(sessionId) {
            var session = TheraFlowData.getSessionById(sessionId);
            if (!session) return;

            var content = 
                '<div style="text-align: center; padding: 20px;">' +
                    '<div style="font-size: 4em; margin-bottom: 15px;">üí∞</div>' +
                    '<h2 style="margin-bottom: 10px;">Confirmar Pagamento</h2>' +
                    '<p style="color: #666; margin-bottom: 20px;">' +
                        '<strong>' + session.clienteNome + '</strong><br>' +
                        session.tipo + ' - ' + TheraFlowUI.formatDateBR(session.data) +
                    '</p>' +
                    '<div style="font-size: 2.5em; font-weight: bold; color: #10b981;">' +
                        TheraFlowUI.formatCurrency(session.valor) +
                    '</div>' +
                '</div>';

            TheraFlowUI.showModal({
                title: 'Receber Pagamento',
                content: content,
                buttons: [
                    { text: 'Cancelar', class: 'tf-btn-secondary', onClick: function() { TheraFlowUI.closeModal(); } },
                    { text: '‚úì Confirmar Recebimento', class: 'tf-btn-success', onClick: function() { markAsPaid(sessionId); } }
                ]
            });
        }

        function markAsPaid(sessionId) {
            TheraFlowData.markSessionPaid(sessionId);
            TheraFlowUI.closeModal();
            TheraFlowUI.toast('Pagamento registrado com sucesso!', 'success');
            loadFinanceData();
            loadSmartSummary();
        }

        // Carregar Resumo Inteligente
        function loadSmartSummary() {
            var smartReport = TheraFlowData.getSmartFinanceReport();
            document.getElementById('smartReceived').textContent = TheraFlowUI.formatCurrency(smartReport.receivedThisMonth);
            document.getElementById('smartPending').textContent = TheraFlowUI.formatCurrency(smartReport.pendingThisMonth);
            document.getElementById('smartNext7Days').textContent = TheraFlowUI.formatCurrency(smartReport.next7Days);
        }

        // Carregar Pacotes
        function loadPackages() {
            var packages = TheraFlowData.getPackages();
            var activePackages = packages.filter(function(p) { return p.sessoesRestantes > 0; });
            
            document.getElementById('packagesCount').textContent = activePackages.length;
            var packagesList = document.getElementById('packagesList');
            
            if (activePackages.length === 0) {
                packagesList.innerHTML = '<div class="empty-state" style="padding: 20px;">üì¶ Nenhum pacote ativo. Crie pacotes para seus clientes!</div>';
                return;
            }
            
            var html = '';
            for (var i = 0; i < activePackages.length; i++) {
                var pkg = activePackages[i];
                var progress = ((pkg.sessoesTotal - pkg.sessoesRestantes) / pkg.sessoesTotal) * 100;
                var alertHtml = '';
                
                if (pkg.sessoesRestantes <= 2) {
                    alertHtml = '<div class="package-alert">‚ö†Ô∏è Aten√ß√£o: Restam apenas ' + pkg.sessoesRestantes + ' sess√µes!</div>';
                }
                
                html += '<div class="package-card">' +
                    '<div class="client-name">üë§ ' + pkg.clienteNome + '</div>' +
                    '<div><strong>' + pkg.nome + '</strong></div>' +
                    '<div class="progress-bar"><div class="progress-fill" style="width: ' + progress + '%"></div></div>' +
                    '<div class="package-info">' +
                        '<span>' + (pkg.sessoesTotal - pkg.sessoesRestantes) + ' de ' + pkg.sessoesTotal + ' usadas</span>' +
                        '<span>Restam: ' + pkg.sessoesRestantes + '</span>' +
                    '</div>' +
                    alertHtml +
                '</div>';
            }
            packagesList.innerHTML = html;
        }

        // Modal para adicionar pacote
        function showAddPackageModal() {
            var clients = TheraFlowData.getClients();
            
            if (clients.length === 0) {
                TheraFlowUI.alert('Aten√ß√£o', 'Voc√™ precisa cadastrar clientes primeiro!');
                return;
            }
            
            var clientOptions = clients.map(function(c) {
                return '<option value="' + c.id + '">' + c.nome + '</option>';
            }).join('');
            
            var content = 
                '<form id="packageForm">' +
                    '<div class="tf-form-group">' +
                        '<label>Cliente *</label>' +
                        '<select name="clienteId" required>' +
                            '<option value="">Selecione...</option>' +
                            clientOptions +
                        '</select>' +
                    '</div>' +
                    '<div class="tf-form-group">' +
                        '<label>Nome do Pacote *</label>' +
                        '<select name="nome">' +
                            '<option value="Pacote 5 sess√µes">Pacote 5 sess√µes</option>' +
                            '<option value="Pacote 10 sess√µes">Pacote 10 sess√µes</option>' +
                            '<option value="Pacote Mensal">Pacote Mensal (4 sess√µes)</option>' +
                            '<option value="Pacote Trimestral">Pacote Trimestral (12 sess√µes)</option>' +
                        '</select>' +
                    '</div>' +
                    '<div class="tf-form-group">' +
                        '<label>Quantidade de Sess√µes *</label>' +
                        '<input type="number" name="sessoesTotal" value="5" min="1" required>' +
                    '</div>' +
                    '<div class="tf-form-group">' +
                        '<label>Valor Total (R$) *</label>' +
                        '<input type="number" name="valorTotal" value="500" step="10" required>' +
                    '</div>' +
                '</form>';
            
            TheraFlowUI.showModal({
                title: 'üì¶ Novo Pacote de Sess√µes',
                content: content,
                buttons: [
                    { text: 'Cancelar', onClick: function() { TheraFlowUI.closeModal(); } },
                    { text: 'Criar Pacote', primary: true, onClick: savePackage }
                ]
            });
        }

        function savePackage() {
            var form = document.getElementById('packageForm');
            var formData = new FormData(form);
            var clienteId = formData.get('clienteId');
            
            if (!clienteId) {
                TheraFlowUI.toast('Selecione um cliente', 'error');
                return;
            }
            
            var client = TheraFlowData.getClientById(clienteId);
            var pkg = {
                clienteId: parseInt(clienteId),
                clienteNome: client.nome,
                nome: formData.get('nome'),
                sessoesTotal: parseInt(formData.get('sessoesTotal')),
                valorTotal: parseFloat(formData.get('valorTotal')),
                valorPorSessao: parseFloat(formData.get('valorTotal')) / parseInt(formData.get('sessoesTotal'))
            };
            
            TheraFlowData.addPackage(pkg);
            TheraFlowUI.closeModal();
            TheraFlowUI.toast('Pacote criado com sucesso!', 'success');
            loadPackages();
        }

        // Modal de Exporta√ß√£o
        function showExportModal() {
            var content = 
                '<div style="text-align: center; padding: 20px;">' +
                    '<div style="font-size: 4em; margin-bottom: 20px;">üìä</div>' +
                    '<h3 style="margin-bottom: 20px;">Exportar Relat√≥rio Mensal</h3>' +
                    '<p style="color: #666; margin-bottom: 20px;">Per√≠odo: ' + meses[currentMonth] + ' ' + currentYear + '</p>' +
                    '<div style="display: flex; gap: 15px; justify-content: center;">' +
                        '<button onclick="exportPDF()" style="padding: 15px 30px; background: #667eea; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1em;">üìÑ Gerar PDF</button>' +
                        '<button onclick="exportCSV()" style="padding: 15px 30px; background: #10b981; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1em;">üìä Exportar CSV</button>' +
                    '</div>' +
                '</div>';
            
            TheraFlowUI.showModal({
                title: 'üìÑ Exportar Relat√≥rio',
                content: content,
                buttons: [
                    { text: 'Fechar', onClick: function() { TheraFlowUI.closeModal(); } }
                ]
            });
        }

        function exportPDF() {
            var reportData = TheraFlowData.generateMonthlyReport(currentYear, currentMonth);
            reportData.period = meses[currentMonth] + ' ' + currentYear;
            TheraFlowUI.generatePDFReport(reportData);
            TheraFlowUI.toast('Relat√≥rio gerado!', 'success');
        }

        function exportCSV() {
            var reportData = TheraFlowData.generateMonthlyReport(currentYear, currentMonth);
            var csvData = reportData.sessions.map(function(s) {
                return {
                    Data: s.data,
                    Cliente: s.clienteNome,
                    Tipo: s.tipo,
                    Valor: s.valor,
                    Status: s.status,
                    Pagamento: s.pagamento
                };
            });
            
            if (csvData.length === 0) {
                TheraFlowUI.toast('Nenhuma sess√£o para exportar', 'warning');
                return;
            }
            
            TheraFlowUI.exportToCSV(csvData, 'relatorio_' + currentYear + '_' + currentMonth + '.csv');
            TheraFlowUI.toast('CSV exportado!', 'success');
        }

        loadSmartSummary();
        loadPackages();
        loadFinanceData();
    </script>
</body>
</html>
