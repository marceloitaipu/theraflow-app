<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TheraFlow - Financeiro</title>
    <link rel="stylesheet" href="styles/common.css">
    <style>
        /* Estilos espec√≠ficos da p√°gina Financeiro */
        .summary-card { background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; }
        .summary-total { text-align: center; margin-bottom: 25px; }
        .summary-total .label { font-size: 0.9em; color: #666; margin-bottom: 8px; }
        .summary-total .value { font-size: 3em; font-weight: bold; color: #10b981; }
        .summary-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .summary-item { text-align: center; padding: 15px; background: #f9f9f9; border-radius: 10px; }
        .summary-item .label { font-size: 0.85em; color: #666; margin-bottom: 8px; }
        .summary-item .value { font-size: 1.5em; font-weight: bold; }
        .summary-item .value.green { color: #10b981; }
        .summary-item .value.orange { color: #f59e0b; }
        .summary-item .value.purple { color: #667eea; }
        .summary-item .value.blue { color: #3b82f6; }
        
        /* Resumo Inteligente */
        .smart-summary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; }
        .smart-summary-title { font-size: 1.1em; margin-bottom: 15px; opacity: 0.95; }
        .smart-summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .smart-summary-item { text-align: center; background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px; }
        .smart-summary-item .icon { font-size: 1.5em; margin-bottom: 8px; }
        .smart-summary-item .value { font-size: 1.4em; font-weight: bold; }
        .smart-summary-item .label { font-size: 0.8em; opacity: 0.9; margin-top: 5px; }
        
        /* Pacotes */
        .packages-section { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; }
        .package-alert { background: #fef3c7; color: #92400e; padding: 10px 15px; border-radius: 8px; font-size: 0.9em; margin-top: 10px; }
        
        /* Bot√µes de a√ß√£o */
        .action-buttons { display: flex; gap: 10px; margin-bottom: 20px; }
        .action-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 0.9em; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .action-btn.primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .action-btn.secondary { background: #f0f0f0; color: #333; }
        .section { margin-bottom: 30px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Financeiro</h1>
        <div class="month-selector">
            <button onclick="changeMonth(-1)">‚óÄ</button>
            <span id="currentMonth">Janeiro 2026</span>
            <button onclick="changeMonth(1)">‚ñ∂</button>
        </div>
    </div>

    <div class="container">
        <!-- Resumo Financeiro Inteligente -->
        <div class="smart-summary">
            <div class="smart-summary-title">üìä Resumo Financeiro Inteligente <span id="growthBadge" style="font-size: 0.8em; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 15px; margin-left: 10px;"></span></div>
            <div class="smart-summary-grid">
                <div class="smart-summary-item">
                    <div class="icon">üí∞</div>
                    <div class="value" id="smartReceived">R$ 0</div>
                    <div class="label">Recebido este m√™s</div>
                </div>
                <div class="smart-summary-item">
                    <div class="icon">‚è≥</div>
                    <div class="value" id="smartPending">R$ 0</div>
                    <div class="label">Pendente</div>
                </div>
                <div class="smart-summary-item">
                    <div class="icon">üìÖ</div>
                    <div class="value" id="smartNext7Days">R$ 0</div>
                    <div class="label">Pr√≥ximos 7 dias</div>
                </div>
            </div>
            
            <!-- Comparativo com m√™s anterior -->
            <div id="comparisonSection" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);"></div>
        </div>
        
        <!-- Indicadores de Performance -->
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px;">
            <div style="background: white; padding: 15px; border-radius: 12px; text-align: center;">
                <div style="font-size: 1.5em; font-weight: bold; color: #667eea;" id="avgMonthly">R$ 0</div>
                <div style="font-size: 0.85em; color: #666;">M√©dia Mensal</div>
            </div>
            <div style="background: white; padding: 15px; border-radius: 12px; text-align: center;">
                <div style="font-size: 1.5em; font-weight: bold; color: #10b981;" id="bestMonthValue">R$ 0</div>
                <div style="font-size: 0.85em; color: #666;" id="bestMonthLabel">Melhor M√™s</div>
            </div>
        </div>

        <!-- Pacotes de Sess√µes (visualiza√ß√£o) -->
        <div class="packages-section" id="packagesSection">
            <h2 class="section-title">üì¶ Pacotes Ativos <span class="count" id="packagesCount">0</span></h2>
            <div id="packagesList"></div>
            <p style="text-align: center; color: #666; font-size: 0.85em; margin-top: 10px;">
                üí° Crie pacotes na p√°gina de <a href="clientes.html" style="color: #667eea;">Clientes</a>
            </p>
        </div>

        <!-- Bot√µes de A√ß√£o -->
        <div class="action-buttons">
            <button class="action-btn secondary" onclick="showExportModal()">üìÑ Exportar Relat√≥rio</button>
        </div>

        <div class="summary-card">
            <div class="summary-total">
                <div class="label">Total do M√™s</div>
                <div class="value" id="totalValue">R$ 0</div>
            </div>
            <div class="summary-grid">
                <div class="summary-item"><div class="label">‚úì Recebido</div><div class="value green" id="receivedValue">R$ 0</div></div>
                <div class="summary-item"><div class="label">‚è≥ Pendente</div><div class="value orange" id="pendingValue">R$ 0</div></div>
                <div class="summary-item"><div class="label">üìÖ Sess√µes</div><div class="value purple" id="sessionsCount">0</div></div>
                <div class="summary-item"><div class="label">üìä Ticket M√©dio</div><div class="value purple" id="averageValue">R$ 0</div></div>
            </div>
        </div>

        <div class="section" id="pendingSection">
            <h2 class="section-title">Pagamentos Pendentes <span class="count" id="pendingCount">0</span></h2>
            <div id="pendingList"></div>
        </div>

        <div class="section" id="paidSection">
            <h2 class="section-title">Pagamentos Recebidos <span class="count" id="paidCount">0</span></h2>
            <div id="paidList"></div>
        </div>
    </div>

    <!-- Navega√ß√£o injetada via JavaScript -->
    <div id="nav-container"></div>

    <script src="js/data.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/components.js"></script>
    <script>
        // Verificar login e injetar navega√ß√£o
        TheraFlowUI.checkAuth();
        TheraFlowComponents.injectNavigation('financeiro');

        // Garantir que existam dados de demonstra√ß√£o
        if (TheraFlowData.getClients().length === 0) {
            TheraFlowData.resetData();
        }

        var currentYear = new Date().getFullYear();
        var currentMonth = new Date().getMonth() + 1;

        // Usar meses do componente centralizado
        var meses = [''].concat(TheraFlowComponents.MONTHS);

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 12) { currentMonth = 1; currentYear++; }
            if (currentMonth < 1) { currentMonth = 12; currentYear--; }
            loadFinanceData();
        }

        function loadFinanceData() {
            document.getElementById('currentMonth').textContent = meses[currentMonth] + ' ' + currentYear;
            
            var report = TheraFlowData.getFinanceReport(currentYear, currentMonth);
            
            document.getElementById('totalValue').textContent = TheraFlowUI.formatCurrency(report.total);
            document.getElementById('receivedValue').textContent = TheraFlowUI.formatCurrency(report.totalReceived);
            document.getElementById('pendingValue').textContent = TheraFlowUI.formatCurrency(report.totalPending);
            document.getElementById('sessionsCount').textContent = report.totalSessions;
            document.getElementById('averageValue').textContent = report.totalSessions > 0 
                ? TheraFlowUI.formatCurrency(report.total / report.totalSessions) : 'R$ 0';

            // Buscar sess√µes do m√™s
            var monthStr = currentYear + '-' + String(currentMonth).padStart(2, '0');
            var allSessions = TheraFlowData.getSessions();
            var monthSessions = [];
            var pendingSessions = [];
            var paidSessions = [];
            
            for (var i = 0; i < allSessions.length; i++) {
                var s = allSessions[i];
                if (s.data && s.data.indexOf(monthStr) === 0) {
                    monthSessions.push(s);
                    if (s.pagamento === 'pendente') {
                        pendingSessions.push(s);
                    } else if (s.pagamento === 'pago') {
                        paidSessions.push(s);
                    }
                }
            }

            document.getElementById('pendingCount').textContent = pendingSessions.length;
            document.getElementById('paidCount').textContent = paidSessions.length;

            // Renderizar pendentes
            var pendingList = document.getElementById('pendingList');
            if (pendingSessions.length === 0) {
                pendingList.innerHTML = '<div class="empty-state">üéâ Nenhum pagamento pendente!</div>';
            } else {
                var pendingHtml = '';
                for (var j = 0; j < pendingSessions.length; j++) {
                    var ps = pendingSessions[j];
                    pendingHtml += '<div class="payment-card" onclick="confirmPayment(' + ps.id + ')">' +
                        '<div class="header-row">' +
                            '<span class="client">' + ps.clienteNome + '</span>' +
                            '<span class="pay-value">' + TheraFlowUI.formatCurrency(ps.valor) + '</span>' +
                        '</div>' +
                        '<div class="details">' + TheraFlowUI.formatDateBR(ps.data) + ' ‚Ä¢ ' + ps.tipo + '</div>' +
                    '</div>';
                }
                pendingList.innerHTML = pendingHtml;
            }

            // Renderizar pagos
            var paidList = document.getElementById('paidList');
            if (paidSessions.length === 0) {
                paidList.innerHTML = '<div class="empty-state">Nenhum pagamento recebido neste m√™s</div>';
            } else {
                var paidHtml = '';
                for (var k = 0; k < paidSessions.length; k++) {
                    var pds = paidSessions[k];
                    paidHtml += '<div class="payment-card paid">' +
                        '<div class="header-row">' +
                            '<span class="client">' + pds.clienteNome + ' <span class="status-badge">‚úì Pago</span></span>' +
                            '<span class="pay-value">' + TheraFlowUI.formatCurrency(pds.valor) + '</span>' +
                        '</div>' +
                        '<div class="details">' + TheraFlowUI.formatDateBR(pds.data) + ' ‚Ä¢ ' + pds.tipo + '</div>' +
                    '</div>';
                }
                paidList.innerHTML = paidHtml;
            }
        }

        function confirmPayment(sessionId) {
            var session = TheraFlowData.getSessionById(sessionId);
            if (!session) return;

            var content = 
                '<div style="text-align: center; padding: 20px;">' +
                    '<div style="font-size: 4em; margin-bottom: 15px;">üí∞</div>' +
                    '<h2 style="margin-bottom: 10px;">Confirmar Pagamento</h2>' +
                    '<p style="color: #666; margin-bottom: 20px;">' +
                        '<strong>' + session.clienteNome + '</strong><br>' +
                        session.tipo + ' - ' + TheraFlowUI.formatDateBR(session.data) +
                    '</p>' +
                    '<div style="font-size: 2.5em; font-weight: bold; color: #10b981;">' +
                        TheraFlowUI.formatCurrency(session.valor) +
                    '</div>' +
                '</div>';

            TheraFlowUI.showModal({
                title: 'Receber Pagamento',
                content: content,
                buttons: [
                    { text: 'Cancelar', class: 'tf-btn-secondary', onClick: function() { TheraFlowUI.closeModal(); } },
                    { text: '‚úì Confirmar Recebimento', class: 'tf-btn-success', onClick: function() { markAsPaid(sessionId); } }
                ]
            });
        }

        function markAsPaid(sessionId) {
            TheraFlowData.markSessionPaid(sessionId);
            TheraFlowUI.closeModal();
            TheraFlowUI.toast('Pagamento registrado com sucesso!', 'success');
            loadFinanceData();
            loadSmartSummary();
        }

        // Carregar Resumo Inteligente
        function loadSmartSummary() {
            var smartReport = TheraFlowData.getSmartFinanceReport();
            var indicators = TheraFlowData.getProgressIndicators();
            
            document.getElementById('smartReceived').textContent = TheraFlowUI.formatCurrency(smartReport.receivedThisMonth);
            document.getElementById('smartPending').textContent = TheraFlowUI.formatCurrency(smartReport.pendingThisMonth);
            document.getElementById('smartNext7Days').textContent = TheraFlowUI.formatCurrency(smartReport.next7Days);
            
            // Badge de crescimento
            var growthBadge = document.getElementById('growthBadge');
            if (smartReport.growthPercent !== 0) {
                var isPositive = smartReport.growthPercent > 0;
                growthBadge.innerHTML = (isPositive ? '‚Üë +' : '‚Üì ') + smartReport.growthPercent + '%';
                growthBadge.style.background = isPositive ? 'rgba(16,185,129,0.3)' : 'rgba(239,68,68,0.3)';
            } else {
                growthBadge.innerHTML = '';
            }
            
            // Comparativo com m√™s anterior
            var compSection = document.getElementById('comparisonSection');
            if (smartReport.prevMonthReceived > 0 || smartReport.receivedThisMonth > 0) {
                var diff = smartReport.receivedThisMonth - smartReport.prevMonthReceived;
                var diffColor = diff >= 0 ? '#d1fae5' : '#fee2e2';
                var diffText = diff >= 0 ? '+' : '';
                
                compSection.innerHTML = 
                    '<div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9em;">' +
                        '<span style="opacity: 0.9;">vs. M√™s Anterior:</span>' +
                        '<span style="background: ' + diffColor + '; color: ' + (diff >= 0 ? '#059669' : '#dc2626') + '; padding: 4px 10px; border-radius: 10px; font-weight: 600;">' +
                            diffText + TheraFlowUI.formatCurrency(diff) +
                        '</span>' +
                    '</div>';
            } else {
                compSection.innerHTML = '';
            }
            
            // M√©dia mensal e melhor m√™s
            document.getElementById('avgMonthly').textContent = TheraFlowUI.formatCurrency(indicators.monthlyAverage);
            document.getElementById('bestMonthValue').textContent = TheraFlowUI.formatCurrency(indicators.bestMonthValue);
            
            if (indicators.bestMonth) {
                var parts = indicators.bestMonth.split('-');
                var monthNames = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                document.getElementById('bestMonthLabel').textContent = 'Melhor: ' + monthNames[parseInt(parts[1]) - 1] + '/' + parts[0];
            }
        }

        // Carregar Pacotes
        function loadPackages() {
            var packages = TheraFlowData.getPackages();
            var activePackages = packages.filter(function(p) { return p.sessoesRestantes > 0; });
            
            document.getElementById('packagesCount').textContent = activePackages.length;
            var packagesList = document.getElementById('packagesList');
            
            if (activePackages.length === 0) {
                packagesList.innerHTML = '<div class="empty-state" style="padding: 20px;">üì¶ Nenhum pacote ativo. Crie pacotes para seus clientes!</div>';
                return;
            }
            
            var html = '';
            for (var i = 0; i < activePackages.length; i++) {
                var pkg = activePackages[i];
                var progress = ((pkg.sessoesTotal - pkg.sessoesRestantes) / pkg.sessoesTotal) * 100;
                var alertHtml = '';
                
                if (pkg.sessoesRestantes <= 2) {
                    alertHtml = '<div class="package-alert">‚ö†Ô∏è Aten√ß√£o: Restam apenas ' + pkg.sessoesRestantes + ' sess√µes!</div>';
                }
                
                html += '<div class="package-card">' +
                    '<div class="client-name">üë§ ' + pkg.clienteNome + '</div>' +
                    '<div><strong>' + pkg.nome + '</strong></div>' +
                    '<div class="progress-bar"><div class="progress-fill" style="width: ' + progress + '%"></div></div>' +
                    '<div class="package-info">' +
                        '<span>' + (pkg.sessoesTotal - pkg.sessoesRestantes) + ' de ' + pkg.sessoesTotal + ' usadas</span>' +
                        '<span>Restam: ' + pkg.sessoesRestantes + '</span>' +
                    '</div>' +
                    alertHtml +
                '</div>';
            }
            packagesList.innerHTML = html;
        }

        // Modal de Exporta√ß√£o
        function showExportModal() {
            var content = 
                '<div style="text-align: center; padding: 20px;">' +
                    '<div style="font-size: 4em; margin-bottom: 20px;">üìä</div>' +
                    '<h3 style="margin-bottom: 20px;">Exportar Relat√≥rio Mensal</h3>' +
                    '<p style="color: #666; margin-bottom: 20px;">Per√≠odo: ' + meses[currentMonth] + ' ' + currentYear + '</p>' +
                    '<div style="display: flex; gap: 15px; justify-content: center;">' +
                        '<button onclick="exportPDF()" style="padding: 15px 30px; background: #667eea; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1em;">üìÑ Gerar PDF</button>' +
                        '<button onclick="exportCSV()" style="padding: 15px 30px; background: #10b981; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1em;">üìä Exportar CSV</button>' +
                    '</div>' +
                '</div>';
            
            TheraFlowUI.showModal({
                title: 'üìÑ Exportar Relat√≥rio',
                content: content,
                buttons: [
                    { text: 'Fechar', onClick: function() { TheraFlowUI.closeModal(); } }
                ]
            });
        }

        function exportPDF() {
            var reportData = TheraFlowData.generateMonthlyReport(currentYear, currentMonth);
            reportData.period = meses[currentMonth] + ' ' + currentYear;
            TheraFlowUI.generatePDFReport(reportData);
            TheraFlowUI.toast('Relat√≥rio gerado!', 'success');
        }

        function exportCSV() {
            var reportData = TheraFlowData.generateMonthlyReport(currentYear, currentMonth);
            var csvData = reportData.sessions.map(function(s) {
                return {
                    Data: s.data,
                    Cliente: s.clienteNome,
                    Tipo: s.tipo,
                    Valor: s.valor,
                    Status: s.status,
                    Pagamento: s.pagamento
                };
            });
            
            if (csvData.length === 0) {
                TheraFlowUI.toast('Nenhuma sess√£o para exportar', 'warning');
                return;
            }
            
            TheraFlowUI.exportToCSV(csvData, 'relatorio_' + currentYear + '_' + currentMonth + '.csv');
            TheraFlowUI.toast('CSV exportado!', 'success');
        }

        loadSmartSummary();
        loadPackages();
        loadFinanceData();
    </script>
</body>
</html>
