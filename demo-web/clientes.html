<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TheraFlow - Clientes</title>
    <link rel="stylesheet" href="styles/common.css">
    <style>
        /* Estilos espec√≠ficos da p√°gina Clientes */
        .stats {
            background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-around;
        }
        .stat-item { text-align: center; }
        .stat-item .number { font-size: 2em; font-weight: bold; color: #667eea; }
        .stat-item .label { font-size: 0.85em; color: #666; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Meus Clientes</h1>
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="üîç Buscar cliente...">
        </div>
    </div>

    <div class="container">
        <div class="stats">
            <div class="stat-item"><div class="number" id="totalClients">0</div><div class="label">Total</div></div>
            <div class="stat-item"><div class="number" id="activeClients">0</div><div class="label">Ativos</div></div>
            <div class="stat-item"><div class="number" id="totalSessions">0</div><div class="label">Sess√µes</div></div>
        </div>
        <div id="clientList"></div>
    </div>

    <button class="fab" onclick="showAddClientModal()">+</button>

    <!-- Navega√ß√£o injetada via JavaScript -->
    <div id="nav-container"></div>

    <script src="js/data.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/components.js"></script>
    <script>
        // Verificar login e injetar navega√ß√£o
        TheraFlowUI.checkAuth();
        TheraFlowComponents.injectNavigation('clientes');

        // Garantir que os dados de exemplo existam
        if (TheraFlowData.getClients().length === 0) {
            TheraFlowData.resetData();
        }

        function loadClients() {
            var clients = TheraFlowData.getClients();
            
            // Ordenar clientes por nome em ordem alfab√©tica
            clients.sort(function(a, b) {
                var nomeA = (a.nome || '').toLowerCase();
                var nomeB = (b.nome || '').toLowerCase();
                if (nomeA < nomeB) return -1;
                if (nomeA > nomeB) return 1;
                return 0;
            });
            
            var container = document.getElementById('clientList');
            
            console.log('Clientes carregados:', clients);
            
            // Stats
            document.getElementById('totalClients').textContent = clients.length;
            var totalSessions = 0;
            var activeCount = 0;
            for (var i = 0; i < clients.length; i++) {
                totalSessions += (clients[i].sessoes || 0);
                if (clients[i].sessoes > 0) activeCount++;
            }
            document.getElementById('totalSessions').textContent = totalSessions;
            document.getElementById('activeClients').textContent = activeCount;

            if (clients.length === 0) {
                container.innerHTML = 
                    '<div class="empty-state">' +
                        '<div class="icon">üë•</div>' +
                        '<p>Nenhum cliente cadastrado</p>' +
                        '<button onclick="showAddClientModal()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 30px; border-radius: 25px; font-size: 1em; cursor: pointer; margin-top: 15px;">+ Adicionar Cliente</button>' +
                    '</div>';
                return;
            }

            var html = '';
            for (var i = 0; i < clients.length; i++) {
                var client = clients[i];
                var initial = client.nome ? client.nome.charAt(0).toUpperCase() : '?';
                var createdDate = client.createdAt ? TheraFlowUI.formatDateBR(client.createdAt.split('T')[0]) : 'N/A';
                
                html += '<div class="client-card" onclick="showClientDetails(' + client.id + ')">' +
                    '<div class="name">' +
                        '<div class="avatar">' + initial + '</div>' +
                        (client.nome || 'Sem nome') +
                    '</div>' +
                    '<div class="info">üì± ' + (client.telefone || 'N√£o informado') + '</div>' +
                    '<div class="info">üìß ' + (client.email || 'N√£o informado') + '</div>' +
                    '<div class="stats-row">' +
                        '<span>' + (client.sessoes || 0) + ' sess√µes</span>' +
                        '<span>Desde ' + createdDate + '</span>' +
                    '</div>' +
                '</div>';
            }
            container.innerHTML = html;
        }

        function showClientDetails(id) {
            var client = TheraFlowData.getClientById(id);
            if (!client) {
                TheraFlowUI.toast('Cliente n√£o encontrado', 'error');
                return;
            }

            // Obter timeline inteligente do cliente
            var timeline = TheraFlowData.getClientTimeline(id);
            
            var sessionsHtml = '';
            if (timeline.sessions.length === 0) {
                sessionsHtml = '<p style="color: #999; text-align: center;">Nenhuma sess√£o registrada</p>';
            } else {
                var displaySessions = timeline.sessions.slice(0, 5);
                for (var i = 0; i < displaySessions.length; i++) {
                    var s = displaySessions[i];
                    var badgeClass = s.pagamento === 'pago' ? 'tf-badge-success' : 'tf-badge-warning';
                    var statusIcon = s.status === 'realizado' ? '‚úì' : s.status === 'faltou' ? '‚úó' : '‚è≥';
                    sessionsHtml += '<div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0; align-items: center;">' +
                        '<div>' +
                            '<span style="font-weight: 500;">' + TheraFlowUI.formatDateBR(s.data) + '</span>' +
                            '<span style="color: #999; font-size: 0.9em;"> ' + s.hora + '</span>' +
                            '<div style="font-size: 0.85em; color: #666;">' + s.tipo + '</div>' +
                            (s.notas ? '<div style="font-size: 0.8em; color: #888; font-style: italic;">üìù ' + s.notas.substring(0, 40) + (s.notas.length > 40 ? '...' : '') + '</div>' : '') +
                        '</div>' +
                        '<span class="status-badge ' + badgeClass + '">' + statusIcon + ' ' + TheraFlowUI.formatCurrency(s.valor) + '</span>' +
                    '</div>';
                }
                if (timeline.sessions.length > 5) {
                    sessionsHtml += '<p style="text-align: center; color: #667eea; font-size: 0.9em; padding: 10px; cursor: pointer;" onclick="showAllClientSessions(' + id + ')">Ver todas as ' + timeline.sessions.length + ' sess√µes ‚Üí</p>';
                }
            }

            var initial = client.nome ? client.nome.charAt(0).toUpperCase() : '?';
            
            // Indicadores de timeline
            var timelineIndicators = '';
            if (timeline.completedSessions > 0) {
                timelineIndicators = 
                    '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px;">' +
                        '<div style="background: #f0fdf4; padding: 10px; border-radius: 10px; text-align: center;">' +
                            '<div style="font-weight: bold; color: #059669; font-size: 1.2em;">' + timeline.completedSessions + '</div>' +
                            '<div style="font-size: 0.75em; color: #666;">Sess√µes</div>' +
                        '</div>' +
                        '<div style="background: #eff6ff; padding: 10px; border-radius: 10px; text-align: center;">' +
                            '<div style="font-weight: bold; color: #3b82f6; font-size: 1.2em;">' + TheraFlowUI.formatCurrency(timeline.avgValue) + '</div>' +
                            '<div style="font-size: 0.75em; color: #666;">M√©dia</div>' +
                        '</div>' +
                        '<div style="background: #fef3c7; padding: 10px; border-radius: 10px; text-align: center;">' +
                            '<div style="font-weight: bold; color: #d97706; font-size: 1.2em;">' + (timeline.avgFrequencyDays || '-') + 'd</div>' +
                            '<div style="font-size: 0.75em; color: #666;">Frequ√™ncia</div>' +
                        '</div>' +
                        '<div style="background: ' + (timeline.noShowRate > 20 ? '#fee2e2' : '#f8fafc') + '; padding: 10px; border-radius: 10px; text-align: center;">' +
                            '<div style="font-weight: bold; color: ' + (timeline.noShowRate > 20 ? '#dc2626' : '#666') + '; font-size: 1.2em;">' + timeline.noShowRate + '%</div>' +
                            '<div style="font-size: 0.75em; color: #666;">Faltas</div>' +
                        '</div>' +
                    '</div>';
            }
            
            // Total gasto
            var totalSpentHtml = timeline.totalSpent > 0 ? 
                '<div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 12px; border-radius: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">' +
                    '<span>üí∞ Total investido</span>' +
                    '<strong style="font-size: 1.2em;">' + TheraFlowUI.formatCurrency(timeline.totalSpent) + '</strong>' +
                '</div>' : '';
            
            // √öltima anota√ß√£o destacada
            var lastNoteHtml = timeline.lastNote ? 
                '<div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 15px;">' +
                    '<strong>üìù √öltima anota√ß√£o:</strong>' +
                    '<p style="margin-top: 5px; font-style: italic;">"' + timeline.lastNote + '"</p>' +
                '</div>' : '';
            
            var content = 
                '<div style="text-align: center; margin-bottom: 20px;">' +
                    '<div style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 2em; font-weight: bold; margin: 0 auto 15px;">' +
                        initial +
                    '</div>' +
                    '<h2 style="margin-bottom: 5px;">' + client.nome + '</h2>' +
                    '<p style="color: #666;">Cliente desde ' + TheraFlowUI.formatDateBR(client.createdAt) + '</p>' +
                '</div>' +

                timelineIndicators +
                totalSpentHtml +
                lastNoteHtml +

                '<div style="background: #f8f9ff; padding: 15px; border-radius: 10px; margin-bottom: 20px;">' +
                    '<p style="margin-bottom: 8px;"><strong>üì±</strong> ' + (client.telefone || 'N√£o informado') + '</p>' +
                    '<p style="margin-bottom: 8px;"><strong>üìß</strong> ' + (client.email || 'N√£o informado') + '</p>' +
                    (client.notas && client.notas !== timeline.lastNote ? '<p><strong>üìù</strong> ' + client.notas + '</p>' : '') +
                '</div>' +

                '<h4 style="margin-bottom: 10px;">üìÖ Hist√≥rico de Sess√µes</h4>' +
                '<div style="max-height: 200px; overflow-y: auto; background: white; border-radius: 10px; padding: 10px;">' + sessionsHtml + '</div>' +

                // Mostrar pacotes ativos do cliente
                '<div id="clientPackagesSection" style="margin-top: 20px;">' + getClientPackagesHtml(id) + '</div>' +

                '<ul style="margin-top: 20px; list-style: none; padding: 0;">' +
                    '<li onclick="scheduleForClient(' + id + ')" style="display: flex; align-items: center; gap: 15px; padding: 15px; margin-bottom: 8px; background: #f8f9fa; border-radius: 10px; cursor: pointer;">' +
                        '<span style="font-size: 1.5em;">üìÖ</span>' +
                        '<div><strong style="display: block;">Agendar Atendimento</strong><span style="font-size: 0.85em; color: #666;">Criar nova sess√£o</span></div>' +
                    '</li>' +
                    '<li onclick="showAddPackageModal(' + id + ')" style="display: flex; align-items: center; gap: 15px; padding: 15px; margin-bottom: 8px; background: #f0fdf4; border-radius: 10px; cursor: pointer; color: #059669;">' +
                        '<span style="font-size: 1.5em;">üì¶</span>' +
                        '<div><strong style="display: block;">Criar Pacote de Sess√µes</strong><span style="font-size: 0.85em; color: #666;">Pacote 5, 10 sess√µes...</span></div>' +
                    '</li>' +
                    '<li onclick="editClient(' + id + ')" style="display: flex; align-items: center; gap: 15px; padding: 15px; margin-bottom: 8px; background: #f8f9fa; border-radius: 10px; cursor: pointer;">' +
                        '<span style="font-size: 1.5em;">‚úèÔ∏è</span>' +
                        '<div><strong style="display: block;">Editar Cliente</strong><span style="font-size: 0.85em; color: #666;">Alterar informa√ß√µes</span></div>' +
                    '</li>' +
                    '<li onclick="confirmDeleteClient(' + id + ')" style="display: flex; align-items: center; gap: 15px; padding: 15px; margin-bottom: 8px; background: #fff5f5; border-radius: 10px; cursor: pointer; color: #ef4444;">' +
                        '<span style="font-size: 1.5em;">üóëÔ∏è</span>' +
                        '<div><strong style="display: block;">Excluir Cliente</strong><span style="font-size: 0.85em; color: #666;">Remover cadastro</span></div>' +
                    '</li>' +
                '</ul>';

            TheraFlowUI.showModal({ title: 'Detalhes do Cliente', content: content });
        }
        
        function showAllClientSessions(clienteId) {
            var sessions = TheraFlowData.getSessionsByClient(clienteId);
            var client = TheraFlowData.getClientById(clienteId);
            
            var html = '<div style="max-height: 400px; overflow-y: auto;">';
            for (var i = 0; i < sessions.length; i++) {
                var s = sessions[i];
                var badgeClass = s.pagamento === 'pago' ? 'tf-badge-success' : 'tf-badge-warning';
                var statusIcon = s.status === 'realizado' ? '‚úì' : s.status === 'faltou' ? '‚úó' : '‚è≥';
                html += '<div style="padding: 15px; border-bottom: 1px solid #f0f0f0;">' +
                    '<div style="display: flex; justify-content: space-between; align-items: center;">' +
                        '<div>' +
                            '<strong>' + TheraFlowUI.formatDateBR(s.data) + '</strong> √†s ' + s.hora +
                            '<div style="font-size: 0.9em; color: #666;">' + s.tipo + '</div>' +
                        '</div>' +
                        '<span class="status-badge ' + badgeClass + '">' + statusIcon + ' ' + TheraFlowUI.formatCurrency(s.valor) + '</span>' +
                    '</div>' +
                    (s.notas ? '<div style="font-size: 0.85em; color: #888; margin-top: 5px; font-style: italic;">üìù ' + s.notas + '</div>' : '') +
                '</div>';
            }
            html += '</div>';
            
            TheraFlowUI.closeModal();
            setTimeout(function() {
                TheraFlowUI.showModal({
                    title: 'üìÖ Hist√≥rico Completo - ' + client.nome,
                    content: html,
                    buttons: [
                        { text: 'Voltar', onClick: function() { TheraFlowUI.closeModal(); showClientDetails(clienteId); } }
                    ]
                });
            }, 300);
        }

        function getClientPackagesHtml(clienteId) {
            var packages = TheraFlowData.getActivePackagesByClient(clienteId);
            if (packages.length === 0) return '';
            
            var html = '<h4 style="margin-bottom: 10px;">üì¶ Pacotes Ativos</h4>';
            for (var i = 0; i < packages.length; i++) {
                var pkg = packages[i];
                var progress = ((pkg.sessoesTotal - pkg.sessoesRestantes) / pkg.sessoesTotal) * 100;
                var alertStyle = pkg.sessoesRestantes <= 2 ? 'border: 2px solid #f59e0b;' : '';
                
                html += '<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; border-radius: 10px; margin-bottom: 8px; ' + alertStyle + '">' +
                    '<div style="font-weight: 600; margin-bottom: 5px;">' + pkg.nome + '</div>' +
                    '<div style="background: rgba(255,255,255,0.3); height: 6px; border-radius: 3px; margin: 8px 0;">' +
                        '<div style="background: white; height: 100%; border-radius: 3px; width: ' + progress + '%;"></div>' +
                    '</div>' +
                    '<div style="display: flex; justify-content: space-between; font-size: 0.85em;">' +
                        '<span>' + (pkg.sessoesTotal - pkg.sessoesRestantes) + '/' + pkg.sessoesTotal + ' usadas</span>' +
                        '<span>Restam: ' + pkg.sessoesRestantes + '</span>' +
                    '</div>' +
                    (pkg.sessoesRestantes <= 2 ? '<div style="background: rgba(255,255,255,0.2); padding: 5px 8px; border-radius: 5px; margin-top: 8px; font-size: 0.8em;">‚ö†Ô∏è Pacote acabando!</div>' : '') +
                '</div>';
            }
            return html;
        }

        function showAddPackageModal(clienteId) {
            TheraFlowUI.closeModal();
            var client = TheraFlowData.getClientById(clienteId);
            if (!client) return;
            
            setTimeout(function() {
                var content = 
                    '<div style="text-align: center; margin-bottom: 20px;">' +
                        '<div style="font-size: 3em; margin-bottom: 10px;">üì¶</div>' +
                        '<p style="color: #666;">Criar pacote para <strong>' + client.nome + '</strong></p>' +
                    '</div>' +
                    '<form id="packageForm">' +
                        '<input type="hidden" name="clienteId" value="' + clienteId + '">' +
                        '<div class="tf-form-group">' +
                            '<label>Tipo de Pacote *</label>' +
                            '<select name="tipo" onchange="updatePackageFields(this.value)">' +
                                '<option value="5">Pacote 5 sess√µes</option>' +
                                '<option value="10">Pacote 10 sess√µes</option>' +
                                '<option value="4">Pacote Mensal (4 sess√µes)</option>' +
                                '<option value="12">Pacote Trimestral (12 sess√µes)</option>' +
                                '<option value="custom">Personalizado</option>' +
                            '</select>' +
                        '</div>' +
                        '<div class="tf-form-group">' +
                            '<label>Quantidade de Sess√µes</label>' +
                            '<input type="number" name="sessoesTotal" id="sessoesTotal" value="5" min="1">' +
                        '</div>' +
                        '<div class="tf-form-group">' +
                            '<label>Valor Total (R$)</label>' +
                            '<input type="number" name="valorTotal" id="valorTotal" value="500" step="10">' +
                        '</div>' +
                        '<div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-top: 15px;">' +
                            '<div style="display: flex; justify-content: space-between;">' +
                                '<span>Valor por sess√£o:</span>' +
                                '<strong id="valorPorSessao">R$ 100,00</strong>' +
                            '</div>' +
                            '<div style="display: flex; justify-content: space-between; margin-top: 5px; color: #059669;">' +
                                '<span>Economia vs avulso:</span>' +
                                '<strong id="economia">~17%</strong>' +
                            '</div>' +
                        '</div>' +
                    '</form>';
                
                TheraFlowUI.showModal({
                    title: 'üì¶ Novo Pacote de Sess√µes',
                    content: content,
                    buttons: [
                        { text: 'Cancelar', onClick: function() { TheraFlowUI.closeModal(); showClientDetails(clienteId); } },
                        { text: 'Criar Pacote', primary: true, onClick: function() { savePackage(clienteId); } }
                    ]
                });
                
                // Atualizar campos ao carregar
                updatePackageFields('5');
            }, 300);
        }

        function updatePackageFields(tipo) {
            var sessoes = parseInt(tipo);
            var valores = { 5: 500, 10: 900, 4: 400, 12: 1080 };
            var precoAvulso = 120;
            
            if (tipo === 'custom') {
                document.getElementById('sessoesTotal').disabled = false;
                return;
            }
            
            document.getElementById('sessoesTotal').value = sessoes;
            document.getElementById('sessoesTotal').disabled = true;
            document.getElementById('valorTotal').value = valores[sessoes] || sessoes * 100;
            
            var valor = valores[sessoes] || sessoes * 100;
            var valorPorSessao = valor / sessoes;
            var economia = Math.round((1 - valorPorSessao / precoAvulso) * 100);
            
            document.getElementById('valorPorSessao').textContent = 'R$ ' + valorPorSessao.toFixed(2).replace('.', ',');
            document.getElementById('economia').textContent = '~' + economia + '%';
        }

        function savePackage(clienteId) {
            var form = document.getElementById('packageForm');
            var formData = new FormData(form);
            var client = TheraFlowData.getClientById(clienteId);
            
            var sessoesTotal = parseInt(formData.get('sessoesTotal'));
            var valorTotal = parseFloat(formData.get('valorTotal'));
            
            var pkg = {
                clienteId: parseInt(clienteId),
                clienteNome: client.nome,
                nome: 'Pacote ' + sessoesTotal + ' sess√µes',
                sessoesTotal: sessoesTotal,
                valorTotal: valorTotal,
                valorPorSessao: valorTotal / sessoesTotal
            };
            
            TheraFlowData.addPackage(pkg);
            TheraFlowUI.closeModal();
            TheraFlowUI.toast('Pacote criado com sucesso! üì¶', 'success');
            
            setTimeout(function() {
                showClientDetails(clienteId);
            }, 300);
        }

        function showAddClientModal() {
            // Verificar limite do plano
            var limits = TheraFlowData.checkPlanLimits();
            
            if (limits.isAtLimit) {
                var content = 
                    '<div style="text-align: center; padding: 20px;">' +
                        '<div style="font-size: 4em; margin-bottom: 15px;">üö´</div>' +
                        '<h3 style="margin-bottom: 15px; color: #ef4444;">Limite de Clientes Atingido</h3>' +
                        '<p style="color: #666; margin-bottom: 20px;">Voc√™ atingiu o limite de <strong>' + limits.clientLimit + ' clientes</strong> do plano ' + limits.plan.toUpperCase() + '.</p>' +
                        '<div style="background: #fef3c7; padding: 15px; border-radius: 10px; margin-bottom: 20px;">' +
                            '<p style="color: #92400e; font-weight: 600;">üí° Fa√ßa upgrade para continuar crescendo!</p>' +
                        '</div>' +
                        '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">' +
                            '<div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center;">' +
                                '<div style="font-weight: bold; color: #667eea;">Pro</div>' +
                                '<div style="font-size: 1.3em; font-weight: bold;">R$ 29/m√™s</div>' +
                                '<div style="font-size: 0.85em; color: #666;">50 clientes + Pacotes</div>' +
                            '</div>' +
                            '<div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center;">' +
                                '<div style="font-weight: bold; color: #333;">Premium</div>' +
                                '<div style="font-size: 1.3em; font-weight: bold;">R$ 49/m√™s</div>' +
                                '<div style="font-size: 0.85em; color: #666;">Ilimitado + Relat√≥rios</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
                
                TheraFlowUI.showModal({
                    title: '‚ö†Ô∏è Limite Atingido',
                    content: content,
                    buttons: [
                        { text: 'Fechar', onClick: function() { TheraFlowUI.closeModal(); } },
                        { text: 'Ver Planos', primary: true, onClick: function() {
                            TheraFlowUI.closeModal();
                            window.location.href = 'perfil.html';
                        }}
                    ]
                });
                return;
            }
            
            var content = 
                '<form id="addClientForm">' +
                    '<div class="tf-form-group"><label>Nome *</label><input type="text" name="nome" required placeholder="Nome completo"></div>' +
                    '<div class="tf-form-group"><label>Telefone</label><input type="tel" name="telefone" placeholder="(11) 99999-9999"></div>' +
                    '<div class="tf-form-group"><label>Email</label><input type="email" name="email" placeholder="cliente@email.com"></div>' +
                    '<div class="tf-form-group"><label>Observa√ß√µes</label><textarea name="notas" rows="3" placeholder="Anota√ß√µes sobre o cliente..."></textarea></div>' +
                '</form>' +
                (limits.clientsRemaining <= 2 ? '<div style="background: #fef3c7; padding: 10px; border-radius: 8px; margin-top: 15px; font-size: 0.9em; color: #92400e;">‚ö†Ô∏è Restam apenas ' + limits.clientsRemaining + ' clientes no seu plano</div>' : '');

            TheraFlowUI.showModal({
                title: '‚ûï Novo Cliente',
                content: content,
                buttons: [
                    { text: 'Cancelar', class: 'tf-btn-secondary', onClick: function() { TheraFlowUI.closeModal(); } },
                    { text: 'Salvar', class: 'tf-btn-primary', onClick: function() { saveNewClient(); } }
                ]
            });
        }

        function saveNewClient() {
            var form = document.getElementById('addClientForm');
            var nome = form.nome.value.trim();
            
            if (!nome) { 
                TheraFlowUI.toast('Nome √© obrigat√≥rio', 'error'); 
                return; 
            }

            TheraFlowData.addClient({
                nome: nome,
                telefone: form.telefone.value.trim() || '',
                email: form.email.value.trim() || '',
                notas: form.notas.value.trim() || ''
            });

            TheraFlowUI.closeModal();
            TheraFlowUI.toast('Cliente adicionado com sucesso!', 'success');
            loadClients();
        }

        function editClient(id) {
            TheraFlowUI.closeModal();
            var client = TheraFlowData.getClientById(id);
            if (!client) return;
            
            setTimeout(function() {
                var content = 
                    '<form id="editClientForm">' +
                        '<div class="tf-form-group"><label>Nome *</label><input type="text" name="nome" value="' + (client.nome || '') + '" required></div>' +
                        '<div class="tf-form-group"><label>Telefone</label><input type="tel" name="telefone" value="' + (client.telefone || '') + '"></div>' +
                        '<div class="tf-form-group"><label>Email</label><input type="email" name="email" value="' + (client.email || '') + '"></div>' +
                        '<div class="tf-form-group"><label>Observa√ß√µes</label><textarea name="notas" rows="3">' + (client.notas || '') + '</textarea></div>' +
                    '</form>';

                TheraFlowUI.showModal({
                    title: '‚úèÔ∏è Editar Cliente',
                    content: content,
                    buttons: [
                        { text: 'Cancelar', class: 'tf-btn-secondary', onClick: function() { TheraFlowUI.closeModal(); } },
                        { text: 'Salvar', class: 'tf-btn-primary', onClick: function() { updateClient(id); } }
                    ]
                });
            }, 250);
        }

        function updateClient(id) {
            var form = document.getElementById('editClientForm');
            
            TheraFlowData.updateClient(id, {
                nome: form.nome.value.trim(),
                telefone: form.telefone.value.trim(),
                email: form.email.value.trim(),
                notas: form.notas.value.trim()
            });

            TheraFlowUI.closeModal();
            TheraFlowUI.toast('Cliente atualizado!', 'success');
            loadClients();
        }

        function confirmDeleteClient(id) {
            TheraFlowUI.closeModal();
            setTimeout(function() {
                TheraFlowUI.confirm('Deseja realmente excluir este cliente?', function() {
                    TheraFlowData.deleteClient(id);
                    TheraFlowUI.toast('Cliente exclu√≠do', 'success');
                    loadClients();
                });
            }, 250);
        }

        function scheduleForClient(id) {
            TheraFlowUI.closeModal();
            localStorage.setItem('theraflow_schedule_client', id.toString());
            window.location.href = 'app.html';
        }

        // Busca
        document.getElementById('searchInput').addEventListener('input', function(e) {
            var query = e.target.value.toLowerCase();
            var cards = document.querySelectorAll('.client-card');
            for (var i = 0; i < cards.length; i++) {
                var name = cards[i].querySelector('.name').textContent.toLowerCase();
                cards[i].style.display = name.indexOf(query) !== -1 ? 'block' : 'none';
            }
        });

        // Inicializar
        loadClients();
    </script>
</body>
</html>
