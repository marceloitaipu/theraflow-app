<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TheraFlow - Agenda</title>
    <link rel="stylesheet" href="styles/common.css">
    <style>
        /* Estilos espec√≠ficos da p√°gina Agenda */
        .calendar {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }

        .weekday {
            text-align: center;
            font-size: 0.85em;
            color: #888;
            font-weight: 600;
            padding: 10px 0;
        }

        .days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95em;
            position: relative;
            transition: all 0.2s;
        }

        .day:hover {
            background: #f0f0f0;
        }

        .day.today {
            background: #667eea;
            color: white;
            font-weight: bold;
        }

        .day.has-sessions::after {
            content: '';
            position: absolute;
            bottom: 5px;
            width: 6px;
            height: 6px;
            background: #f59e0b;
            border-radius: 50%;
        }

        .day.today.has-sessions::after {
            background: white;
        }

        .day.other-month {
            color: #ccc;
        }

        .day.selected {
            background: #764ba2;
            color: white;
            font-weight: bold;
        }

        .session-list {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .session-item {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.2s;
        }

        .session-item:hover {
            background: #f0f0f0;
            transform: translateX(5px);
        }

        .session-item:last-child {
            margin-bottom: 0;
        }

        .session-item .time {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .session-item .client {
            font-size: 1.05em;
            color: #333;
            margin-bottom: 3px;
        }

        .session-item .type {
            font-size: 0.9em;
            color: #666;
        }

        .session-item .status-badge.pending {
            background: #fef3c7;
            color: #d97706;
        }

        .session-item .status-badge.completed {
            background: #d1fae5;
            color: #059669;
        }

        .session-item .status-badge.paid {
            background: #dbeafe;
            color: #2563eb;
        }

        .session-item .status-badge.missed {
            background: #fee2e2;
            color: #dc2626;
        }

        .empty-day {
            text-align: center;
            padding: 30px;
            color: #999;
        }
        
        .fab-add {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 2em;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            z-index: 100;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .session-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .session-actions button {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .btn-complete {
            background: #d1fae5;
            color: #059669;
        }

        .btn-missed {
            background: #fee2e2;
            color: #dc2626;
        }

        .btn-paid {
            background: #dbeafe;
            color: #2563eb;
        }

        .btn-reschedule {
            background: #fef3c7;
            color: #d97706;
        }

        .btn-cancel {
            background: #f3f4f6;
            color: #6b7280;
            grid-column: span 2;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: #666;
        }

        .detail-value {
            font-weight: 600;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìÖ Agenda</h1>
        <div class="month-selector">
            <button onclick="changeMonth(-1)">‚óÄ</button>
            <span id="currentMonth">Janeiro 2026</span>
            <button onclick="changeMonth(1)">‚ñ∂</button>
        </div>
    </div>

    <div class="container">
        <div class="calendar">
            <div class="weekdays">
                <div class="weekday">Dom</div>
                <div class="weekday">Seg</div>
                <div class="weekday">Ter</div>
                <div class="weekday">Qua</div>
                <div class="weekday">Qui</div>
                <div class="weekday">Sex</div>
                <div class="weekday">S√°b</div>
            </div>
            <div class="days" id="calendarDays"></div>
        </div>

        <h2 class="section-title">Sess√µes do dia <span id="selectedDate">07/01/2026</span></h2>
        
        <div class="session-list" id="sessionList">
            <div class="empty-day">
                <div style="font-size: 3em; margin-bottom: 10px;">üì≠</div>
                <div>Carregando...</div>
            </div>
        </div>
        
        <button class="fab-add" onclick="showNewSessionModal()">+</button>
    </div>

    <!-- Navega√ß√£o injetada via JavaScript -->
    <div id="nav-container"></div>

    <script src="js/data.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/components.js"></script>
    <script>
        // Verificar autentica√ß√£o e injetar navega√ß√£o
        TheraFlowUI.checkAuth();
        TheraFlowComponents.injectNavigation('agenda');

        // Estado
        var currentDate = new Date();
        var selectedDate = new Date();
        var allSessions = [];

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
        });

        function loadData() {
            allSessions = TheraFlowData.getSessions();
            renderCalendar();
            renderDaySessions();
        }

        function renderCalendar() {
            var year = currentDate.getFullYear();
            var month = currentDate.getMonth();
            
            // Usar meses do componente centralizado
            document.getElementById('currentMonth').textContent = TheraFlowComponents.MONTHS[month] + ' ' + year;
            
            var firstDay = new Date(year, month, 1).getDay();
            var lastDate = new Date(year, month + 1, 0).getDate();
            var lastDayPrevMonth = new Date(year, month, 0).getDate();
            
            // Encontrar dias com sess√µes
            var daysWithSessions = getDaysWithSessions(year, month);
            
            var daysContainer = document.getElementById('calendarDays');
            daysContainer.innerHTML = '';
            
            // Dias do m√™s anterior
            for (var i = firstDay - 1; i >= 0; i--) {
                var day = document.createElement('div');
                day.className = 'day other-month';
                day.textContent = lastDayPrevMonth - i;
                daysContainer.appendChild(day);
            }
            
            // Dias do m√™s atual
            var today = new Date();
            for (var i = 1; i <= lastDate; i++) {
                var day = document.createElement('div');
                day.className = 'day';
                day.textContent = i;
                
                // Verificar se √© hoje
                if (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    day.classList.add('today');
                }
                
                // Verificar se tem sess√µes
                if (daysWithSessions.indexOf(i) !== -1) {
                    day.classList.add('has-sessions');
                }
                
                // Verificar se est√° selecionado
                if (i === selectedDate.getDate() && month === selectedDate.getMonth() && year === selectedDate.getFullYear()) {
                    day.classList.add('selected');
                }
                
                (function(dayNum) {
                    day.onclick = function() { selectDay(dayNum); };
                })(i);
                
                daysContainer.appendChild(day);
            }
            
            // Dias do pr√≥ximo m√™s
            var remainingCells = 42 - daysContainer.children.length;
            for (var i = 1; i <= remainingCells; i++) {
                var day = document.createElement('div');
                day.className = 'day other-month';
                day.textContent = i;
                daysContainer.appendChild(day);
            }
        }

        function getDaysWithSessions(year, month) {
            var days = [];
            allSessions.forEach(function(session) {
                var sessionDate = new Date(session.data + 'T12:00:00');
                if (sessionDate.getFullYear() === year && sessionDate.getMonth() === month) {
                    var day = sessionDate.getDate();
                    if (days.indexOf(day) === -1) {
                        days.push(day);
                    }
                }
            });
            return days;
        }

        function selectDay(day) {
            selectedDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
            renderCalendar();
            renderDaySessions();
        }

        function renderDaySessions() {
            var dateStr = selectedDate.toISOString().split('T')[0];
            document.getElementById('selectedDate').textContent = TheraFlowUI.formatDateBR(dateStr);
            
            var daySessions = allSessions.filter(function(s) {
                return s.data === dateStr;
            }).sort(function(a, b) {
                return a.hora.localeCompare(b.hora);
            });
            
            var sessionList = document.getElementById('sessionList');
            
            if (daySessions.length === 0) {
                sessionList.innerHTML = 
                    '<div class="empty-day">' +
                        '<div style="font-size: 3em; margin-bottom: 10px;">üì≠</div>' +
                        '<div>Nenhum atendimento agendado</div>' +
                        '<div style="margin-top: 10px; color: #667eea; cursor: pointer;" onclick="showNewSessionModal()">+ Agendar atendimento</div>' +
                    '</div>';
                return;
            }
            
            var html = '';
            
            daySessions.forEach(function(session) {
                var statusBadge = '';
                if (session.status === 'realizado' && session.pagamento === 'pago') {
                    statusBadge = '<span class="status-badge paid">‚úì Pago</span>';
                } else if (session.status === 'realizado') {
                    statusBadge = '<span class="status-badge completed">‚úì Realizado</span>';
                } else if (session.status === 'faltou') {
                    statusBadge = '<span class="status-badge missed">‚úó Faltou</span>';
                } else {
                    statusBadge = '<span class="status-badge pending">Pendente</span>';
                }
                
                html += '<div class="session-item" onclick="showSessionDetail(' + session.id + ')">' +
                    '<div class="time">üïê ' + session.hora + statusBadge + '</div>' +
                    '<div class="client">üë§ ' + session.clienteNome + '</div>' +
                    '<div class="type">üíÜ ' + session.tipo + ' ‚Ä¢ ' + TheraFlowUI.formatCurrency(session.valor) + '</div>' +
                '</div>';
            });
            
            sessionList.innerHTML = html;
        }

        function showNewSessionModal() {
            var clients = TheraFlowData.getClients();
            var profile = TheraFlowData.getProfile();
            var services = profile.servicos || ['Massagem Relaxante', 'Massagem Desportiva', 'Drenagem Linf√°tica', 'Shiatsu', 'Reiki', 'Reflexologia'];
            
            var dateStr = selectedDate.toISOString().split('T')[0];
            
            var clientOptions = clients.map(function(c) {
                return '<option value="' + c.id + '">' + c.nome + '</option>';
            }).join('');
            
            var serviceOptions = services.map(function(s) {
                return '<option value="' + s + '">' + s + '</option>';
            }).join('');
            
            var content = 
                '<form id="newSessionForm">' +
                    // Tipo: Avulso ou Pacote
                    '<div class="form-group">' +
                        '<label>üìã Tipo de Agendamento</label>' +
                        '<div style="display: flex; gap: 10px; margin-top: 5px;">' +
                            '<label style="flex: 1; padding: 12px; border: 2px solid #667eea; border-radius: 10px; text-align: center; cursor: pointer; background: #667eea; color: white;" id="btnAvulso" onclick="toggleAgendamentoType(\'avulso\')">' +
                                '<input type="radio" name="tipoAgendamento" value="avulso" checked style="display: none;"> üíÜ Sess√£o Avulsa' +
                            '</label>' +
                            '<label style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 10px; text-align: center; cursor: pointer;" id="btnPacote" onclick="toggleAgendamentoType(\'pacote\')">' +
                                '<input type="radio" name="tipoAgendamento" value="pacote" style="display: none;"> üì¶ Novo Pacote' +
                            '</label>' +
                        '</div>' +
                    '</div>' +
                    
                    '<div class="form-group">' +
                        '<label>üë§ Cliente</label>' +
                        '<select id="sessionClient" required onchange="onClientChange(this.value)">' +
                            '<option value="">Selecione...</option>' +
                            clientOptions +
                        '</select>' +
                    '</div>' +
                    
                    // Op√ß√£o de usar pacote existente (aparece s√≥ se cliente tem pacote)
                    '<div id="packageExistingOption" style="display: none; background: #f0fdf4; padding: 15px; border-radius: 10px; margin-bottom: 10px;">' +
                        '<label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">' +
                            '<input type="checkbox" id="usePackageCheck" onchange="toggleUseExistingPackage()">' +
                            '<span>üì¶ <strong>Usar sess√£o de pacote existente</strong></span>' +
                        '</label>' +
                        '<div id="packageInfo" style="margin-top: 10px; font-size: 0.9em; color: #059669;"></div>' +
                        '<input type="hidden" id="selectedPackageId" value="">' +
                    '</div>' +
                    
                    '<div class="form-group">' +
                        '<label>üíÜ Tipo de Sess√£o <a href="perfil.html" style="font-size: 0.8em; color: #667eea; float: right;">‚öôÔ∏è Gerenciar</a></label>' +
                        '<select id="sessionType" required onchange="updatePackageValues()">' +
                            '<option value="">Selecione...</option>' +
                            serviceOptions +
                        '</select>' +
                    '</div>' +
                    
                    // Se√ß√£o para sess√£o avulsa
                    '<div id="secaoAvulsa">' +
                        '<div class="form-group">' +
                            '<label>üìÖ Data</label>' +
                            '<input type="date" id="sessionDate" value="' + dateStr + '" required>' +
                        '</div>' +
                        '<div class="form-group">' +
                            '<label>üïê Hor√°rio</label>' +
                            '<input type="time" id="sessionTime" value="09:00" required>' +
                        '</div>' +
                        '<div class="form-group" id="valorGroup">' +
                            '<label>üí∞ Valor (R$)</label>' +
                            '<input type="number" id="sessionValue" placeholder="150" min="0" step="0.01" required>' +
                        '</div>' +
                    '</div>' +
                    
                    // Se√ß√£o para pacote
                    '<div id="secaoPacote" style="display: none;">' +
                        '<div class="form-group">' +
                            '<label>üì¶ Quantidade de Sess√µes</label>' +
                            '<select id="packageQty" onchange="updatePackageValues()">' +
                                '<option value="4">4 sess√µes (5% desc.)</option>' +
                                '<option value="8" selected>8 sess√µes (10% desc.)</option>' +
                                '<option value="12">12 sess√µes (15% desc.)</option>' +
                            '</select>' +
                        '</div>' +
                        '<div id="packagePricing" style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); padding: 15px; border-radius: 10px; margin-bottom: 15px;">' +
                            '<div style="display: flex; justify-content: space-between; margin-bottom: 5px;"><span>Valor unit√°rio:</span><span id="pkgValorUnit">R$ 150,00</span></div>' +
                            '<div style="display: flex; justify-content: space-between; margin-bottom: 5px;"><span>Desconto:</span><span id="pkgDesconto" style="color: #059669;">-10%</span></div>' +
                            '<div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.1em; border-top: 1px solid #86efac; padding-top: 10px; margin-top: 10px;"><span>Total do Pacote:</span><span id="pkgTotal" style="color: #059669;">R$ 1.080,00</span></div>' +
                            '<div style="text-align: center; margin-top: 8px; font-size: 0.85em; color: #059669;">üí∞ Economia de <strong id="pkgEconomia">R$ 120,00</strong></div>' +
                        '</div>' +
                        '<div style="background: #fef3c7; padding: 12px; border-radius: 10px; margin-bottom: 15px;">' +
                            '<strong>üìÖ Agendar sess√µes agora?</strong>' +
                            '<p style="font-size: 0.9em; margin: 5px 0 0 0; color: #92400e;">Voc√™ pode agendar algumas ou todas as sess√µes do pacote agora. As restantes podem ser agendadas depois.</p>' +
                        '</div>' +
                        '<div class="form-group">' +
                            '<label>Quantas sess√µes agendar agora?</label>' +
                            '<select id="sessionsToSchedule" onchange="generateSessionSlots()">' +
                                '<option value="0">Nenhuma (agendar depois)</option>' +
                                '<option value="1">1 sess√£o</option>' +
                                '<option value="2">2 sess√µes</option>' +
                                '<option value="4" selected>4 sess√µes</option>' +
                                '<option value="8">8 sess√µes</option>' +
                            '</select>' +
                        '</div>' +
                        '<div id="sessionSlots"></div>' +
                    '</div>' +
                    
                    '<div class="form-group">' +
                        '<label>üìù Observa√ß√µes</label>' +
                        '<input type="text" id="sessionNotes" placeholder="Observa√ß√µes opcionais...">' +
                    '</div>' +
                '</form>';
            
            TheraFlowUI.showModal({
                title: 'üìÖ Novo Agendamento',
                content: content,
                buttons: [
                    { text: 'Cancelar', onClick: function() { TheraFlowUI.closeModal(); } },
                    { text: 'Agendar', primary: true, onClick: saveNewSession }
                ]
            });
            
            // Gerar slots iniciais
            setTimeout(function() {
                updatePackageValues();
                generateSessionSlots();
            }, 100);
        }
        
        var currentAgendamentoType = 'avulso';
        
        function toggleAgendamentoType(type) {
            currentAgendamentoType = type;
            var btnAvulso = document.getElementById('btnAvulso');
            var btnPacote = document.getElementById('btnPacote');
            var secaoAvulsa = document.getElementById('secaoAvulsa');
            var secaoPacote = document.getElementById('secaoPacote');
            var packageExisting = document.getElementById('packageExistingOption');
            
            if (type === 'avulso') {
                btnAvulso.style.background = '#667eea';
                btnAvulso.style.color = 'white';
                btnAvulso.style.borderColor = '#667eea';
                btnPacote.style.background = 'white';
                btnPacote.style.color = '#333';
                btnPacote.style.borderColor = '#ddd';
                secaoAvulsa.style.display = 'block';
                secaoPacote.style.display = 'none';
                // Mostrar op√ß√£o de pacote existente se cliente tem
                var clienteId = document.getElementById('sessionClient').value;
                if (clienteId) {
                    checkExistingPackages(clienteId);
                }
            } else {
                btnPacote.style.background = '#667eea';
                btnPacote.style.color = 'white';
                btnPacote.style.borderColor = '#667eea';
                btnAvulso.style.background = 'white';
                btnAvulso.style.color = '#333';
                btnAvulso.style.borderColor = '#ddd';
                secaoAvulsa.style.display = 'none';
                secaoPacote.style.display = 'block';
                packageExisting.style.display = 'none';
                updatePackageValues();
                generateSessionSlots();
            }
        }
        
        function onClientChange(clienteId) {
            if (currentAgendamentoType === 'avulso') {
                checkExistingPackages(clienteId);
            }
        }
        
        function checkExistingPackages(clienteId) {
            var packageOption = document.getElementById('packageExistingOption');
            var packageInfo = document.getElementById('packageInfo');
            var selectedPackageId = document.getElementById('selectedPackageId');
            
            if (!clienteId) {
                packageOption.style.display = 'none';
                return;
            }
            
            var packages = TheraFlowData.getActivePackagesByClient(clienteId);
            
            if (packages.length > 0) {
                var pkg = packages[0];
                packageOption.style.display = 'block';
                packageInfo.innerHTML = pkg.nome + ' - Restam <strong>' + pkg.sessoesRestantes + '</strong> sess√µes';
                selectedPackageId.value = pkg.id;
            } else {
                packageOption.style.display = 'none';
                selectedPackageId.value = '';
            }
        }
        
        function toggleUseExistingPackage() {
            var usePackage = document.getElementById('usePackageCheck').checked;
            var valorGroup = document.getElementById('valorGroup');
            var valorInput = document.getElementById('sessionValue');
            
            if (usePackage) {
                valorGroup.style.opacity = '0.5';
                valorInput.value = '0';
                valorInput.disabled = true;
            } else {
                valorGroup.style.opacity = '1';
                valorInput.value = '150';
                valorInput.disabled = false;
            }
        }
        
        function updatePackageValues() {
            var qty = parseInt(document.getElementById('packageQty')?.value || 8);
            var valorUnit = parseFloat(document.getElementById('sessionValue')?.value) || 150;
            
            var descontos = { 4: 0.05, 8: 0.10, 12: 0.15 };
            var desconto = descontos[qty] || 0.10;
            var totalSemDesc = valorUnit * qty;
            var valorDesconto = totalSemDesc * desconto;
            var total = totalSemDesc - valorDesconto;
            
            var pkgValorUnit = document.getElementById('pkgValorUnit');
            var pkgDesconto = document.getElementById('pkgDesconto');
            var pkgTotal = document.getElementById('pkgTotal');
            var pkgEconomia = document.getElementById('pkgEconomia');
            
            if (pkgValorUnit) pkgValorUnit.textContent = TheraFlowUI.formatCurrency(valorUnit);
            if (pkgDesconto) pkgDesconto.textContent = '-' + (desconto * 100) + '%';
            if (pkgTotal) pkgTotal.textContent = TheraFlowUI.formatCurrency(total);
            if (pkgEconomia) pkgEconomia.textContent = TheraFlowUI.formatCurrency(valorDesconto);
            
            // Atualizar op√ß√µes de sess√µes a agendar
            var selectToSchedule = document.getElementById('sessionsToSchedule');
            if (selectToSchedule) {
                var currentVal = parseInt(selectToSchedule.value);
                selectToSchedule.innerHTML = '<option value="0">Nenhuma (agendar depois)</option>';
                for (var i = 1; i <= qty; i++) {
                    var selected = i === Math.min(currentVal, qty) ? ' selected' : '';
                    selectToSchedule.innerHTML += '<option value="' + i + '"' + selected + '>' + i + ' sess' + (i > 1 ? '√µes' : '√£o') + '</option>';
                }
            }
        }
        
        function generateSessionSlots() {
            var container = document.getElementById('sessionSlots');
            var qty = parseInt(document.getElementById('sessionsToSchedule')?.value || 0);
            
            if (!container) return;
            
            if (qty === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">As sess√µes poder√£o ser agendadas posteriormente</p>';
                return;
            }
            
            var baseDate = selectedDate;
            var html = '<div style="max-height: 200px; overflow-y: auto;">';
            
            for (var i = 0; i < qty; i++) {
                var sessionDate = new Date(baseDate);
                sessionDate.setDate(sessionDate.getDate() + (i * 7)); // Uma por semana
                var dateStr = sessionDate.toISOString().split('T')[0];
                
                html += '<div style="display: flex; gap: 10px; margin-bottom: 10px; padding: 10px; background: #f8fafc; border-radius: 8px;">' +
                    '<span style="min-width: 80px; font-weight: bold; color: #667eea;">Sess√£o ' + (i + 1) + '</span>' +
                    '<input type="date" id="slotDate' + i + '" value="' + dateStr + '" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">' +
                    '<input type="time" id="slotTime' + i + '" value="09:00" style="width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">' +
                '</div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function saveNewSession() {
            var clienteId = document.getElementById('sessionClient').value;
            var tipo = document.getElementById('sessionType').value;
            var notas = document.getElementById('sessionNotes').value;
            
            if (!clienteId || !tipo) {
                TheraFlowUI.toast('Selecione cliente e tipo de sess√£o', 'error');
                return;
            }
            
            var client = TheraFlowData.getClientById(clienteId);
            
            // Verificar qual tipo de agendamento
            if (currentAgendamentoType === 'pacote') {
                // Criar novo pacote
                var qty = parseInt(document.getElementById('packageQty').value);
                var valorUnit = parseFloat(document.getElementById('sessionValue')?.value) || 150;
                var descontos = { 4: 0.05, 8: 0.10, 12: 0.15 };
                var desconto = descontos[qty] || 0.10;
                var valorTotal = valorUnit * qty * (1 - desconto);
                
                var nomePacote = 'Pacote ' + qty + ' sess√µes - ' + tipo;
                
                var newPackage = TheraFlowData.addPackage({
                    clienteId: parseInt(clienteId),
                    clienteNome: client.nome,
                    nome: nomePacote,
                    sessoesTotal: qty,
                    valorTotal: valorTotal,
                    tipo: tipo
                });
                
                // Agendar sess√µes selecionadas
                var sessionsToSchedule = parseInt(document.getElementById('sessionsToSchedule').value);
                
                for (var i = 0; i < sessionsToSchedule; i++) {
                    var slotDate = document.getElementById('slotDate' + i);
                    var slotTime = document.getElementById('slotTime' + i);
                    
                    if (slotDate && slotTime && slotDate.value && slotTime.value) {
                        var session = {
                            clienteId: parseInt(clienteId),
                            clienteNome: client.nome,
                            data: slotDate.value,
                            hora: slotTime.value,
                            tipo: tipo,
                            valor: 0,
                            notas: notas || 'Sess√£o do pacote',
                            status: 'confirmado',
                            pagamento: 'pago',
                            usouPacote: true,
                            pacoteId: newPackage.id
                        };
                        
                        TheraFlowData.addSession(session);
                        TheraFlowData.usePackageSession(newPackage.id);
                    }
                }
                
                allSessions = TheraFlowData.getSessions();
                TheraFlowUI.closeModal();
                renderCalendar();
                renderDaySessions();
                
                var msg = 'üì¶ Pacote criado com sucesso!';
                if (sessionsToSchedule > 0) {
                    msg += ' ' + sessionsToSchedule + ' sess√µes agendadas.';
                }
                TheraFlowUI.toast(msg, 'success');
                
            } else {
                // Sess√£o avulsa
                var data = document.getElementById('sessionDate').value;
                var hora = document.getElementById('sessionTime').value;
                var valor = parseFloat(document.getElementById('sessionValue').value) || 0;
                
                // Verificar se est√° usando pacote existente
                var usePackageCheck = document.getElementById('usePackageCheck');
                var usePackage = usePackageCheck && usePackageCheck.checked;
                var packageId = document.getElementById('selectedPackageId') ? document.getElementById('selectedPackageId').value : '';
                
                if (!data || !hora) {
                    TheraFlowUI.toast('Preencha data e hor√°rio', 'error');
                    return;
                }
                
                if (!usePackage && (isNaN(valor) || valor <= 0)) {
                    TheraFlowUI.toast('Informe o valor da sess√£o', 'error');
                    return;
                }
                
                var session = {
                    clienteId: parseInt(clienteId),
                    clienteNome: client.nome,
                    data: data,
                    hora: hora,
                    tipo: tipo,
                    valor: usePackage ? 0 : valor,
                    notas: notas,
                    status: 'confirmado',
                    pagamento: usePackage ? 'pago' : 'pendente',
                    usouPacote: usePackage,
                    pacoteId: usePackage ? parseInt(packageId) : null
                };
                
                // Se usou pacote, descontar sess√£o
                if (usePackage && packageId) {
                    var pkg = TheraFlowData.usePackageSession(parseInt(packageId));
                    if (pkg && pkg.sessoesRestantes <= 2) {
                        setTimeout(function() {
                            TheraFlowUI.toast('‚ö†Ô∏è Aten√ß√£o: Restam apenas ' + pkg.sessoesRestantes + ' sess√µes no pacote!', 'warning');
                        }, 1500);
                    }
                }
                
                TheraFlowData.addSession(session);
                allSessions = TheraFlowData.getSessions();
                
                // Atualizar data selecionada para a data da sess√£o
                selectedDate = new Date(data + 'T12:00:00');
                currentDate = new Date(selectedDate);
                
                TheraFlowUI.closeModal();
                renderCalendar();
                renderDaySessions();
                TheraFlowUI.toast('Atendimento agendado com sucesso!' + (usePackage ? ' (Pacote)' : ''), 'success');
            }
        }

        function showSessionDetail(sessionId) {
            var session = allSessions.find(function(s) { return s.id === sessionId; });
            if (!session) return;
            
            var statusText = 'Agendado';
            if (session.status === 'realizado' && session.pagamento === 'pago') {
                statusText = '‚úÖ Realizado e Pago';
            } else if (session.status === 'realizado') {
                statusText = '‚úÖ Realizado (Aguardando pagamento)';
            } else if (session.status === 'faltou') {
                statusText = '‚ùå Faltou';
            }
            
            var content = 
                '<div class="detail-row">' +
                    '<span class="detail-label">üë§ Cliente</span>' +
                    '<span class="detail-value">' + session.clienteNome + '</span>' +
                '</div>' +
                '<div class="detail-row">' +
                    '<span class="detail-label">üìÖ Data</span>' +
                    '<span class="detail-value">' + TheraFlowUI.formatDateBR(session.data) + '</span>' +
                '</div>' +
                '<div class="detail-row">' +
                    '<span class="detail-label">üïê Hor√°rio</span>' +
                    '<span class="detail-value">' + session.hora + '</span>' +
                '</div>' +
                '<div class="detail-row">' +
                    '<span class="detail-label">üíÜ Tipo</span>' +
                    '<span class="detail-value">' + session.tipo + '</span>' +
                '</div>' +
                '<div class="detail-row">' +
                    '<span class="detail-label">üí∞ Valor</span>' +
                    '<span class="detail-value">' + TheraFlowUI.formatCurrency(session.valor) + '</span>' +
                '</div>' +
                '<div class="detail-row">' +
                    '<span class="detail-label">üìä Status</span>' +
                    '<span class="detail-value">' + statusText + '</span>' +
                '</div>' +
                (session.notas ? '<div class="detail-row"><span class="detail-label">üìù Obs</span><span class="detail-value">' + session.notas + '</span></div>' : '');
            
            // Bot√µes de a√ß√£o baseados no status
            var actions = '';
            if (session.status === 'confirmado') {
                actions = 
                    '<div class="session-actions">' +
                        '<button class="btn-complete" onclick="markSessionStatus(' + sessionId + ', \'realizado\')">‚úÖ Realizado</button>' +
                        '<button class="btn-missed" onclick="markSessionStatus(' + sessionId + ', \'faltou\')">‚ùå Faltou</button>' +
                        '<button class="btn-reschedule" onclick="rescheduleSession(' + sessionId + ')">üìÖ Remarcar</button>' +
                        '<button class="btn-cancel" onclick="cancelSession(' + sessionId + ')">üóëÔ∏è Cancelar</button>' +
                    '</div>';
            } else if (session.status === 'realizado' && session.pagamento === 'pendente') {
                actions = 
                    '<div class="session-actions">' +
                        '<button class="btn-paid" onclick="markSessionPaid(' + sessionId + ')" style="grid-column: span 2;">üí∞ Marcar como Pago</button>' +
                    '</div>';
            }
            
            TheraFlowUI.showModal({
                title: 'üìã Detalhes do Atendimento',
                content: content + actions,
                buttons: [
                    { text: 'Fechar', onClick: function() { TheraFlowUI.closeModal(); } }
                ]
            });
        }

        function markSessionStatus(sessionId, status) {
            TheraFlowData.updateSession(sessionId, { status: status });
            allSessions = TheraFlowData.getSessions();
            
            TheraFlowUI.closeModal();
            renderDaySessions();
            
            if (status === 'realizado') {
                TheraFlowUI.toast('Atendimento marcado como realizado!', 'success');
            } else {
                TheraFlowUI.toast('Falta registrada', 'info');
            }
        }

        function markSessionPaid(sessionId) {
            TheraFlowData.markSessionPaid(sessionId);
            allSessions = TheraFlowData.getSessions();
            
            TheraFlowUI.closeModal();
            renderDaySessions();
            TheraFlowUI.toast('Pagamento confirmado!', 'success');
        }

        function rescheduleSession(sessionId) {
            var session = allSessions.find(function(s) { return s.id === sessionId; });
            if (!session) return;
            
            TheraFlowUI.closeModal();
            
            var content = 
                '<form id="rescheduleForm">' +
                    '<div class="form-group">' +
                        '<label>üìÖ Nova Data</label>' +
                        '<input type="date" id="newDate" value="' + session.data + '" required>' +
                    '</div>' +
                    '<div class="form-group">' +
                        '<label>üïê Novo Hor√°rio</label>' +
                        '<input type="time" id="newTime" value="' + session.hora + '" required>' +
                    '</div>' +
                '</form>';
            
            TheraFlowUI.showModal({
                title: 'üìÖ Remarcar Atendimento',
                content: content,
                buttons: [
                    { text: 'Cancelar', onClick: function() { TheraFlowUI.closeModal(); } },
                    { text: 'Confirmar', primary: true, onClick: function() {
                        var newDate = document.getElementById('newDate').value;
                        var newTime = document.getElementById('newTime').value;
                        
                        if (!newDate || !newTime) {
                            TheraFlowUI.toast('Preencha todos os campos', 'error');
                            return;
                        }
                        
                        TheraFlowData.updateSession(sessionId, { data: newDate, hora: newTime });
                        allSessions = TheraFlowData.getSessions();
                        
                        TheraFlowUI.closeModal();
                        renderCalendar();
                        renderDaySessions();
                        TheraFlowUI.toast('Atendimento remarcado!', 'success');
                    }}
                ]
            });
        }

        function cancelSession(sessionId) {
            TheraFlowUI.confirm(
                'Tem certeza que deseja cancelar este atendimento? Esta a√ß√£o n√£o pode ser desfeita.',
                function() {
                    TheraFlowData.deleteSession(sessionId);
                    allSessions = TheraFlowData.getSessions();
                    
                    TheraFlowUI.closeModal();
                    renderCalendar();
                    renderDaySessions();
                    TheraFlowUI.toast('Atendimento cancelado', 'info');
                }
            );
        }

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderCalendar();
        }
    </script>
</body>
</html>
