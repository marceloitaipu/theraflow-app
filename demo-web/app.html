<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TheraFlow - Home</title>
    <link rel="stylesheet" href="styles/common.css">
    <style>
        /* Estilos espec√≠ficos da p√°gina Home */
        .stats-grid {
            margin-bottom: 30px;
        }
        
        .reminder-session .info { font-size: 0.95em; }
        .reminder-session .actions { display: flex; gap: 8px; }
        .reminder-session .btn { 
            padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; 
            font-size: 0.85em; font-weight: 600;
        }
        .reminder-session .btn-confirm { background: white; color: #10b981; }
        .reminder-session .btn-reschedule { background: rgba(255,255,255,0.3); color: white; }

        .quick-action-btn.success:hover { background: #10b981; border-color: #10b981; }
        .quick-action-btn.danger:hover { background: #ef4444; border-color: #ef4444; }
        
        /* Bot√£o Iniciar Sess√£o */
        .btn-start-session {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white; border: none; padding: 10px 20px; border-radius: 25px;
            font-size: 0.9em; font-weight: 600; cursor: pointer; display: inline-flex;
            align-items: center; gap: 8px; transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-start-session:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); }
        
        /* Modal Iniciar Sess√£o */
        .session-start-modal { padding: 10px 0; }
        .session-start-modal .client-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; text-align: center;
        }
        .session-start-modal .client-info h2 { margin-bottom: 5px; }
        .session-start-modal .client-info p { opacity: 0.9; }
        .session-start-modal .last-note {
            background: #fef3c7; padding: 15px; border-radius: 10px; margin-bottom: 15px;
        }
        .session-start-modal .note-input {
            width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px;
            font-size: 1em; resize: vertical; min-height: 80px;
        }
        .session-start-modal .note-input:focus { border-color: #667eea; outline: none; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Ol√°, <span id="userName">Terapeuta</span>! üëã</h1>
        <p id="currentDate">Carregando...</p>
    </div>

    <div class="container">
        <!-- Badge de Seguran√ßa -->
        <div class="security-badge">
            <span class="icon">üîí</span>
            <span>Seus dados est√£o seguros na nuvem</span>
        </div>

        <!-- Resumo Financeiro Inteligente -->
        <div class="finance-summary">
            <div class="finance-summary-title">üí∞ Resumo Financeiro do M√™s <span id="financeGrowth" class="growth-indicator"></span></div>
            <div class="finance-summary-grid">
                <div class="finance-summary-item">
                    <div class="value" id="financeReceived">R$ 0</div>
                    <div class="label">Recebido</div>
                </div>
                <div class="finance-summary-item">
                    <div class="value" id="financePending">R$ 0</div>
                    <div class="label">Pendente</div>
                </div>
                <div class="finance-summary-item">
                    <div class="value" id="financeNext7">R$ 0</div>
                    <div class="label">Pr√≥x. 7 dias</div>
                </div>
            </div>
        </div>
        
        <!-- Alertas Inteligentes -->
        <div id="alertsSection" class="alerts-section"></div>
        
        <!-- Indicadores de Progresso -->
        <div class="progress-section">
            <h3 style="margin-bottom: 12px; font-size: 1em; color: #333;">üìä Seu Progresso</h3>
            <div class="progress-grid">
                <div class="progress-card highlight">
                    <div class="progress-value" id="progressSessions">0</div>
                    <div class="progress-label">Sess√µes este m√™s</div>
                </div>
                <div class="progress-card">
                    <div class="progress-value" id="progressClients">0</div>
                    <div class="progress-label">Clientes ativos</div>
                </div>
                <div class="progress-card">
                    <div class="progress-value" id="progressNoShow">0%</div>
                    <div class="progress-label">Taxa de faltas</div>
                </div>
                <div class="progress-card">
                    <div class="progress-value" id="progressBestMonth">-</div>
                    <div class="progress-label">Melhor m√™s</div>
                </div>
            </div>
        </div>

        <!-- Lembretes de Amanh√£ -->
        <div id="reminderSection"></div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="number" id="todayCount">0</div>
                <div class="label">Hoje</div>
            </div>
            <div class="stat-card">
                <div class="number" id="weekCount">0</div>
                <div class="label">Esta semana</div>
            </div>
            <div class="stat-card">
                <div class="number" id="monthRevenue">R$ 0</div>
                <div class="label">Este m√™s</div>
            </div>
        </div>

        <div id="sessionsContainer"></div>
    </div>

    <button class="fab" onclick="showNewSessionModal()">+</button>

    <!-- Navega√ß√£o injetada via JavaScript -->
    <div id="nav-container"></div>

    <script src="js/data.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/components.js"></script>
    <script>
        // Verificar autentica√ß√£o
        TheraFlowUI.checkAuth();

        // Injetar navega√ß√£o
        TheraFlowComponents.injectNavigation('home');

        // Carregar dados do perfil
        const profile = TheraFlowData.getProfile();
        document.getElementById('userName').textContent = profile.displayName || 'Terapeuta';

        // Data atual
        const hoje = new Date();
        const diasSemana = ['Domingo', 'Segunda-feira', 'Ter√ßa-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'S√°bado'];
        const meses = TheraFlowComponents.MONTHS.map(m => m.toLowerCase());
        document.getElementById('currentDate').textContent = `${diasSemana[hoje.getDay()]}, ${hoje.getDate()} de ${meses[hoje.getMonth()]} de ${hoje.getFullYear()}`;

        function loadStats() {
            const todaySessions = TheraFlowData.getTodaySessions();
            document.getElementById('todayCount').textContent = todaySessions.length;

            const startOfWeek = new Date(hoje);
            startOfWeek.setDate(hoje.getDate() - hoje.getDay());
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            
            const allSessions = TheraFlowData.getSessions();
            const weekSessions = allSessions.filter(s => {
                const d = new Date(s.data);
                return d >= startOfWeek && d <= endOfWeek;
            });
            document.getElementById('weekCount').textContent = weekSessions.length;

            const report = TheraFlowData.getFinanceReport(hoje.getFullYear(), hoje.getMonth() + 1);
            const revenue = report.totalReceived;
            document.getElementById('monthRevenue').textContent = revenue >= 1000 
                ? `R$ ${(revenue/1000).toFixed(1)}k` : `R$ ${revenue}`;
        }

        function loadSessions() {
            const sessions = TheraFlowData.getTodaySessions();
            const container = document.getElementById('sessionsContainer');

            if (sessions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üìÖ</div>
                        <p>Nenhum atendimento agendado para hoje</p>
                        <button onclick="showNewSessionModal()">+ Agendar Sess√£o</button>
                    </div>`;
                return;
            }

            const now = new Date();
            const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
            let nextSessionId = null;
            
            for (const session of sessions) {
                if (session.hora > currentTime && session.status === 'confirmado') {
                    nextSessionId = session.id;
                    break;
                }
            }

            let html = '';
            
            if (nextSessionId) {
                const nextSession = sessions.find(s => s.id === nextSessionId);
                html += `<h2 class="section-title">Pr√≥ximo Atendimento</h2>${renderSessionCard(nextSession, true)}`;
            }

            html += `<h2 class="section-title">Atendimentos do Dia<span class="badge">${sessions.length}</span></h2>`;
            sessions.forEach(session => { html += renderSessionCard(session, false); });
            container.innerHTML = html;
        }

        function renderSessionCard(session, isNext) {
            const paymentClass = session.pagamento === 'pago' ? 'status-pago' : 'status-pendente';
            const isInProgress = session.status === 'em_andamento';
            return `
                <div class="session-card ${isNext ? 'next' : ''}" onclick="showSessionDetails(${session.id})">
                    <div class="time">${session.hora} - ${TheraFlowComponents.addMinutes(session.hora, session.duracao)} ${isInProgress ? '<span style="color: #10b981; font-weight: normal; font-size: 0.8em;">‚óè Em andamento</span>' : ''}</div>
                    <div class="client">${session.clienteNome}</div>
                    <div class="details">
                        <span>${session.tipo} ‚Ä¢ ${TheraFlowUI.formatCurrency(session.valor)}</span>
                        <span class="status-badge ${paymentClass}">${session.pagamento === 'pago' ? '‚úì Pago' : '‚è≥ Pendente'}</span>
                    </div>
                    <div class="quick-actions" onclick="event.stopPropagation()">
                        ${session.status === 'confirmado' ? `
                            <button class="btn-start-session" onclick="startSessionFlow(${session.id})">‚ñ∂ Iniciar Sess√£o</button>
                        ` : session.status === 'em_andamento' ? `
                            <button class="btn-start-session" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);" onclick="finishSessionFlow(${session.id})">‚èπ Finalizar Sess√£o</button>
                        ` : `<span class="status-badge status-${session.status}">${session.status === 'realizado' ? '‚úì Realizado' : session.status === 'faltou' ? '‚úó Faltou' : session.status}</span>`}
                        ${session.pagamento === 'pendente' && session.status !== 'confirmado' && session.status !== 'em_andamento' ? `
                            <button class="quick-action-btn" onclick="markPaid(${session.id})">üí∞ Marcar Pago</button>
                        ` : ''}
                    </div>
                </div>`;
        }

        // Usa a fun√ß√£o centralizada TheraFlowComponents.addMinutes

        function markDone(id) {
            TheraFlowData.markSessionDone(id);
            TheraFlowUI.toast('Atendimento marcado como realizado!', 'success');
            loadSessions(); loadStats();
        }

        function markNoShow(id) {
            TheraFlowData.markSessionNoShow(id);
            TheraFlowUI.toast('Falta registrada', 'warning');
            loadSessions(); loadStats();
        }

        function markPaid(id) {
            TheraFlowData.markSessionPaid(id);
            TheraFlowUI.toast('Pagamento registrado!', 'success');
            loadSessions(); loadStats();
        }

        function showSessionDetails(id) {
            const session = TheraFlowData.getSessionById(id);
            if (!session) return;

            const content = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 3em; margin-bottom: 10px;">üë§</div>
                    <h2 style="margin-bottom: 5px;">${session.clienteNome}</h2>
                    <p style="color: #666;">${session.tipo}</p>
                </div>
                <div style="background: #f8f9ff; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div><strong style="color: #666; font-size: 0.9em;">üìÖ Data</strong><p>${TheraFlowUI.formatDateBR(session.data)}</p></div>
                        <div><strong style="color: #666; font-size: 0.9em;">‚è∞ Hor√°rio</strong><p>${session.hora}</p></div>
                        <div><strong style="color: #666; font-size: 0.9em;">‚è± Dura√ß√£o</strong><p>${session.duracao} min</p></div>
                        <div><strong style="color: #666; font-size: 0.9em;">üí∞ Valor</strong><p>${TheraFlowUI.formatCurrency(session.valor)}</p></div>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px;">
                    <span class="status-badge status-${session.status}">${session.status === 'em_andamento' ? 'Em andamento' : session.status}</span>
                    <span class="status-badge ${session.pagamento === 'pago' ? 'status-pago' : 'status-pendente'}">${session.pagamento}</span>
                </div>
                ${session.notas ? `<div style="background: #fff3cd; padding: 15px; border-radius: 10px;"><strong>üìù Anota√ß√µes:</strong><p>${session.notas}</p></div>` : ''}
                <ul class="tf-action-list" style="margin-top: 20px;">
                    ${session.status === 'confirmado' ? `
                        <li class="tf-action-item" onclick="TheraFlowUI.closeModal(); startSessionFlow(${id});"><span class="icon">‚ñ∂Ô∏è</span><div class="text"><strong>Iniciar Sess√£o</strong><span>Come√ßar o atendimento agora</span></div></li>
                        <li class="tf-action-item" onclick="markNoShow(${id}); TheraFlowUI.closeModal();"><span class="icon">‚ùå</span><div class="text"><strong>Registrar Falta</strong><span>Cliente n√£o compareceu</span></div></li>
                    ` : session.status === 'em_andamento' ? `
                        <li class="tf-action-item" onclick="TheraFlowUI.closeModal(); finishSessionFlow(${id});"><span class="icon">‚èπÔ∏è</span><div class="text"><strong>Finalizar Sess√£o</strong><span>Encerrar o atendimento</span></div></li>
                    ` : ''}
                    ${session.pagamento === 'pendente' && session.status !== 'confirmado' ? `
                        <li class="tf-action-item" onclick="markPaid(${id}); TheraFlowUI.closeModal();"><span class="icon">üí∞</span><div class="text"><strong>Marcar como Pago</strong><span>Registrar recebimento</span></div></li>
                    ` : ''}
                    <li class="tf-action-item" onclick="window.location.href='clientes.html?id=${session.clienteId}'"><span class="icon">üë§</span><div class="text"><strong>Ver Cliente</strong><span>Abrir perfil completo</span></div></li>
                    <li class="tf-action-item" onclick="confirmDeleteSession(${id})" style="color: #ef4444;"><span class="icon">üóëÔ∏è</span><div class="text"><strong>Excluir Sess√£o</strong><span>Remover este agendamento</span></div></li>
                </ul>`;

            TheraFlowUI.showModal({ title: 'Detalhes do Atendimento', content: content, size: 'medium' });
        }
        
        // === FLUXO INICIAR SESS√ÉO ===
        function startSessionFlow(sessionId) {
            const session = TheraFlowData.getSessionById(sessionId);
            if (!session) return;
            
            // Buscar dados do cliente e timeline
            const timeline = TheraFlowData.getClientTimeline(session.clienteId);
            const lastNote = timeline ? timeline.lastNote : '';
            
            const content = `
                <div class="session-start-modal">
                    <div class="client-info">
                        <h2>${session.clienteNome}</h2>
                        <p>${session.tipo} ‚Ä¢ ${session.duracao} min</p>
                    </div>
                    
                    ${timeline ? `
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; text-align: center;">
                            <div style="background: #f0fdf4; padding: 10px; border-radius: 10px;">
                                <div style="font-weight: bold; color: #059669;">${timeline.completedSessions}</div>
                                <div style="font-size: 0.8em; color: #666;">Sess√µes</div>
                            </div>
                            <div style="background: #eff6ff; padding: 10px; border-radius: 10px;">
                                <div style="font-weight: bold; color: #3b82f6;">${TheraFlowUI.formatCurrency(timeline.avgValue)}</div>
                                <div style="font-size: 0.8em; color: #666;">M√©dia</div>
                            </div>
                            <div style="background: #fef3c7; padding: 10px; border-radius: 10px;">
                                <div style="font-weight: bold; color: #d97706;">${timeline.avgFrequencyDays || '-'}</div>
                                <div style="font-size: 0.8em; color: #666;">Dias freq.</div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${lastNote ? `
                        <div class="last-note">
                            <strong>üìù √öltima anota√ß√£o:</strong>
                            <p style="margin-top: 5px;">${lastNote}</p>
                        </div>
                    ` : ''}
                    
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: 600; display: block; margin-bottom: 8px;">‚úèÔ∏è Anota√ß√£o r√°pida (opcional)</label>
                        <textarea class="note-input" id="sessionStartNote" placeholder="Observa√ß√µes sobre esta sess√£o..."></textarea>
                    </div>
                    
                    <p style="text-align: center; color: #666; font-size: 0.9em;">üí° Hoje √© um bom dia para cuidar!</p>
                </div>`;
            
            TheraFlowUI.showModal({
                title: '‚ñ∂Ô∏è Iniciar Sess√£o',
                content: content,
                buttons: [
                    { text: 'Cancelar', class: 'tf-btn-secondary', onclick: 'TheraFlowUI.closeModal()' },
                    { text: '‚ñ∂ Iniciar Agora', class: 'tf-btn-primary', onclick: `confirmStartSession(${sessionId})` }
                ]
            });
        }
        
        function confirmStartSession(sessionId) {
            const note = document.getElementById('sessionStartNote')?.value || '';
            
            // Atualizar sess√£o com status em_andamento
            TheraFlowData.updateSession(sessionId, {
                status: 'em_andamento',
                inicioReal: new Date().toISOString(),
                notas: note
            });
            
            TheraFlowUI.closeModal();
            TheraFlowUI.toast('Sess√£o iniciada! Seu atendimento em fluxo ‚ú®', 'success');
            loadSessions();
            loadStats();
        }
        
        function finishSessionFlow(sessionId) {
            const session = TheraFlowData.getSessionById(sessionId);
            if (!session) return;
            
            // Verificar se tem pacote para abater
            const packages = TheraFlowData.getActivePackagesByClient(session.clienteId);
            const hasPackage = packages.length > 0;
            
            const content = `
                <div class="session-start-modal">
                    <div class="client-info" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        <h2>${session.clienteNome}</h2>
                        <p>Finalizando ${session.tipo}</p>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: 600; display: block; margin-bottom: 8px;">üìä Como foi a sess√£o?</label>
                        <select id="finishStatus" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em;">
                            <option value="realizado">‚úÖ Realizada com sucesso</option>
                            <option value="faltou">‚ùå Cliente faltou</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: 600; display: block; margin-bottom: 8px;">üí∞ Pagamento</label>
                        <select id="finishPayment" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em;">
                            <option value="pago">‚úì Pago</option>
                            <option value="pendente">‚è≥ Pendente</option>
                            ${hasPackage ? '<option value="pacote">üì¶ Abater do pacote</option>' : ''}
                        </select>
                    </div>
                    
                    ${hasPackage ? `
                        <div id="packageAbateInfo" style="display: none; background: #f0fdf4; padding: 12px; border-radius: 10px; margin-bottom: 15px;">
                            <strong>üì¶ ${packages[0].nome}</strong>
                            <p style="font-size: 0.9em; color: #059669;">Restam ${packages[0].sessoesRestantes} sess√µes</p>
                            <input type="hidden" id="packageToAbate" value="${packages[0].id}">
                        </div>
                    ` : ''}
                    
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: 600; display: block; margin-bottom: 8px;">üìù Anota√ß√µes finais</label>
                        <textarea class="note-input" id="sessionFinishNote" placeholder="Observa√ß√µes sobre a sess√£o...">${session.notas || ''}</textarea>
                    </div>
                </div>`;
            
            TheraFlowUI.showModal({
                title: '‚èπ Finalizar Sess√£o',
                content: content,
                buttons: [
                    { text: 'Cancelar', class: 'tf-btn-secondary', onclick: 'TheraFlowUI.closeModal()' },
                    { text: '‚úì Finalizar', class: 'tf-btn-primary', onclick: `confirmFinishSession(${sessionId})` }
                ]
            });
            
            // Adicionar event listener ap√≥s modal ser criado
            setTimeout(function() {
                var finishPayment = document.getElementById('finishPayment');
                if (finishPayment) {
                    finishPayment.addEventListener('change', function() {
                        var info = document.getElementById('packageAbateInfo');
                        if (info) info.style.display = this.value === 'pacote' ? 'block' : 'none';
                    });
                }
            }, 100);
        }
        
        function confirmFinishSession(sessionId) {
            const status = document.getElementById('finishStatus').value;
            const payment = document.getElementById('finishPayment').value;
            const note = document.getElementById('sessionFinishNote')?.value || '';
            
            let finalPayment = payment;
            
            // Se escolheu pacote, abater sess√£o
            if (payment === 'pacote') {
                const packageId = document.getElementById('packageToAbate')?.value;
                if (packageId) {
                    const pkg = TheraFlowData.usePackageSession(parseInt(packageId));
                    if (pkg && pkg.sessoesRestantes <= 2) {
                        setTimeout(function() {
                            TheraFlowUI.toast('‚ö†Ô∏è Aten√ß√£o: Restam apenas ' + pkg.sessoesRestantes + ' sess√µes no pacote!', 'warning');
                        }, 1500);
                    }
                }
                finalPayment = 'pago';
            }
            
            // Atualizar sess√£o
            TheraFlowData.updateSession(sessionId, {
                status: status,
                pagamento: finalPayment,
                fimReal: new Date().toISOString(),
                notas: note
            });
            
            TheraFlowUI.closeModal();
            TheraFlowUI.toast('Sess√£o finalizada! ' + (status === 'realizado' ? '‚ú® Excelente trabalho!' : ''), 'success');
            loadSessions();
            loadStats();
            loadFinanceSummary();
        }

        function confirmDeleteSession(id) {
            TheraFlowUI.closeModal();
            setTimeout(() => {
                TheraFlowUI.confirm('Deseja realmente excluir esta sess√£o?', function() {
                    TheraFlowData.deleteSession(id);
                    TheraFlowUI.toast('Sess√£o exclu√≠da', 'success');
                    loadSessions(); loadStats();
                });
            }, 250);
        }

        function showNewSessionModal() {
            const clients = TheraFlowData.getClients();
            
            if (clients.length === 0) {
                TheraFlowUI.showModal({
                    title: 'Nenhum Cliente',
                    content: `<div style="text-align: center; padding: 20px;"><div style="font-size: 4em; margin-bottom: 15px;">üë•</div><p>Voc√™ precisa cadastrar um cliente primeiro!</p></div>`,
                    buttons: [{ text: 'Cadastrar Cliente', class: 'tf-btn-primary', onclick: "window.location.href='clientes.html'" }]
                });
                return;
            }

            const clientOptions = clients.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
            const today = TheraFlowData.formatDate(new Date());
            
            // Carregar servi√ßos do perfil
            const profile = TheraFlowData.getProfile();
            const servicos = profile.servicos || ['Massagem Relaxante', 'Massagem Desportiva', 'Drenagem Linf√°tica', 'Shiatsu', 'Reiki', 'Reflexologia'];
            const servicoOptions = servicos.map(s => `<option value="${s}">${s}</option>`).join('');

            const content = `
                <form id="newSessionForm">
                    <div class="tf-form-group"><label>Cliente *</label><select name="clienteId" required onchange="checkClientPackages(this.value)"><option value="">Selecione...</option>${clientOptions}</select></div>
                    <div id="packageOption" style="display: none; background: #f0fdf4; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" name="usePackage" id="usePackageCheck" onchange="togglePackageValue()">
                            <span>üì¶ <strong>Usar sess√£o do pacote</strong></span>
                        </label>
                        <div id="packageInfo" style="margin-top: 10px; font-size: 0.9em; color: #059669;"></div>
                        <input type="hidden" name="packageId" id="selectedPackageId" value="">
                    </div>
                    <div class="tf-form-group"><label>Data *</label><input type="date" name="data" value="${today}" required></div>
                    <div class="tf-form-group"><label>Hor√°rio *</label><input type="time" name="hora" value="09:00" required></div>
                    <div class="tf-form-group">
                        <label>Tipo de Atendimento <a href="perfil.html" style="font-size: 0.8em; color: #667eea; float: right;">‚öôÔ∏è Gerenciar</a></label>
                        <select name="tipo">
                            <option value="">Selecione...</option>
                            ${servicoOptions}
                        </select>
                    </div>
                    <div class="tf-form-group"><label>Dura√ß√£o</label><select name="duracao"><option value="30">30 min</option><option value="45">45 min</option><option value="60" selected>1 hora</option><option value="90">1h30</option><option value="120">2 horas</option></select></div>
                    <div class="tf-form-group" id="valorGroup"><label>Valor (R$)</label><input type="number" name="valor" value="150" step="10"></div>
                    <div class="tf-form-group"><label>Observa√ß√µes</label><textarea name="notas" rows="2" placeholder="Notas..."></textarea></div>
                </form>`;

            TheraFlowUI.showModal({
                title: '‚ûï Novo Agendamento',
                content: content,
                buttons: [
                    { text: 'Cancelar', class: 'tf-btn-secondary', onclick: 'TheraFlowUI.closeModal()' },
                    { text: 'Agendar', class: 'tf-btn-primary', onclick: 'saveNewSession()' }
                ]
            });
        }

        function checkClientPackages(clienteId) {
            var packageOption = document.getElementById('packageOption');
            var packageInfo = document.getElementById('packageInfo');
            var selectedPackageId = document.getElementById('selectedPackageId');
            
            if (!clienteId) {
                packageOption.style.display = 'none';
                return;
            }
            
            var packages = TheraFlowData.getActivePackagesByClient(clienteId);
            
            if (packages.length > 0) {
                var pkg = packages[0]; // Usa o primeiro pacote ativo
                packageOption.style.display = 'block';
                packageInfo.innerHTML = pkg.nome + ' - Restam <strong>' + pkg.sessoesRestantes + '</strong> sess√µes';
                selectedPackageId.value = pkg.id;
            } else {
                packageOption.style.display = 'none';
                selectedPackageId.value = '';
            }
        }

        function togglePackageValue() {
            var usePackage = document.getElementById('usePackageCheck').checked;
            var valorGroup = document.getElementById('valorGroup');
            
            if (usePackage) {
                valorGroup.style.opacity = '0.5';
                valorGroup.querySelector('input').value = '0';
                valorGroup.querySelector('input').disabled = true;
            } else {
                valorGroup.style.opacity = '1';
                valorGroup.querySelector('input').value = '150';
                valorGroup.querySelector('input').disabled = false;
            }
        }

        function saveNewSession() {
            const form = document.getElementById('newSessionForm');
            const formData = new FormData(form);
            const clienteId = formData.get('clienteId');
            if (!clienteId) { TheraFlowUI.toast('Selecione um cliente', 'error'); return; }

            const client = TheraFlowData.getClientById(clienteId);
            const usePackage = document.getElementById('usePackageCheck') && document.getElementById('usePackageCheck').checked;
            const packageId = document.getElementById('selectedPackageId') ? document.getElementById('selectedPackageId').value : '';
            
            const session = {
                clienteId: parseInt(clienteId),
                clienteNome: client.nome,
                data: formData.get('data'),
                hora: formData.get('hora'),
                tipo: formData.get('tipo'),
                duracao: parseInt(formData.get('duracao')),
                valor: usePackage ? 0 : (parseFloat(formData.get('valor')) || 0),
                notas: formData.get('notas') || '',
                status: 'confirmado',
                pagamento: usePackage ? 'pago' : 'pendente',
                usouPacote: usePackage,
                pacoteId: usePackage ? parseInt(packageId) : null
            };

            // Se usou pacote, descontar sess√£o
            if (usePackage && packageId) {
                var pkg = TheraFlowData.usePackageSession(parseInt(packageId));
                if (pkg && pkg.sessoesRestantes <= 2) {
                    setTimeout(function() {
                        TheraFlowUI.toast('‚ö†Ô∏è Aten√ß√£o: Restam apenas ' + pkg.sessoesRestantes + ' sess√µes no pacote!', 'warning');
                    }, 1500);
                }
            }

            TheraFlowData.addSession(session);
            TheraFlowUI.closeModal();
            TheraFlowUI.toast('Sess√£o agendada com sucesso!' + (usePackage ? ' (Pacote)' : ''), 'success');
            loadSessions(); loadStats(); loadFinanceSummary();
        }

        loadStats();
        loadSessions();
        loadFinanceSummary();
        loadReminders();
        loadAlerts();
        loadProgressIndicators();

        // Carregar Resumo Financeiro Inteligente
        function loadFinanceSummary() {
            var smartReport = TheraFlowData.getSmartFinanceReport();
            document.getElementById('financeReceived').textContent = TheraFlowUI.formatCurrency(smartReport.receivedThisMonth);
            document.getElementById('financePending').textContent = TheraFlowUI.formatCurrency(smartReport.pendingThisMonth);
            document.getElementById('financeNext7').textContent = TheraFlowUI.formatCurrency(smartReport.next7Days);
            
            // Indicador de crescimento
            var growthEl = document.getElementById('financeGrowth');
            if (smartReport.growthPercent !== 0) {
                var isPositive = smartReport.growthPercent > 0;
                growthEl.className = 'growth-indicator ' + (isPositive ? 'growth-positive' : 'growth-negative');
                growthEl.textContent = (isPositive ? '‚Üë +' : '‚Üì ') + smartReport.growthPercent + '% vs m√™s ant.';
            } else {
                growthEl.textContent = '';
            }
        }
        
        // Carregar Alertas Inteligentes
        function loadAlerts() {
            var alerts = TheraFlowData.getSmartAlerts();
            var alertsSection = document.getElementById('alertsSection');
            
            if (alerts.length === 0) {
                alertsSection.innerHTML = '';
                return;
            }
            
            // Limitar a 3 alertas na home
            var displayAlerts = alerts.slice(0, 3);
            
            var html = '<h3 style="margin-bottom: 12px; font-size: 1em; color: #333;">üîî Alertas</h3>';
            displayAlerts.forEach(function(alert) {
                html += '<div class="alert-card priority-' + alert.priority + '" onclick="handleAlertClick(\'' + alert.type + '\', ' + (alert.clientId || alert.packageId || 'null') + ')">' +
                    '<span class="alert-icon">' + alert.icon + '</span>' +
                    '<div class="alert-content">' +
                        '<div class="alert-title">' + alert.title + '</div>' +
                        '<div class="alert-message">' + alert.message + '</div>' +
                    '</div>' +
                    '<span style="color: #ccc;">‚Ä∫</span>' +
                '</div>';
            });
            
            if (alerts.length > 3) {
                html += '<p style="text-align: center; color: #667eea; font-size: 0.9em; cursor: pointer;" onclick="showAllAlerts()">Ver todos os ' + alerts.length + ' alertas</p>';
            }
            
            alertsSection.innerHTML = html;
        }
        
        function handleAlertClick(type, id) {
            if (type === 'churn_risk' || type === 'reactivation') {
                window.location.href = 'clientes.html?highlight=' + id;
            } else if (type === 'package_low') {
                window.location.href = 'clientes.html';
            } else if (type === 'payment_overdue') {
                window.location.href = 'financeiro.html';
            } else if (type === 'confirmation') {
                window.location.href = 'agenda.html';
            }
        }
        
        function showAllAlerts() {
            var alerts = TheraFlowData.getSmartAlerts();
            var html = '<div style="max-height: 400px; overflow-y: auto;">';
            alerts.forEach(function(alert) {
                html += '<div style="padding: 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 12px;">' +
                    '<span style="font-size: 1.5em;">' + alert.icon + '</span>' +
                    '<div>' +
                        '<div style="font-weight: 600;">' + alert.title + '</div>' +
                        '<div style="font-size: 0.85em; color: #666;">' + alert.message + '</div>' +
                    '</div>' +
                '</div>';
            });
            html += '</div>';
            
            TheraFlowUI.showModal({
                title: 'üîî Todos os Alertas',
                content: html,
                buttons: [{ text: 'Fechar', onclick: 'TheraFlowUI.closeModal()' }]
            });
        }
        
        // Carregar Indicadores de Progresso
        function loadProgressIndicators() {
            var indicators = TheraFlowData.getProgressIndicators();
            
            document.getElementById('progressSessions').textContent = indicators.sessionsThisMonth;
            document.getElementById('progressClients').textContent = indicators.activeClients;
            document.getElementById('progressNoShow').textContent = indicators.noShowRate + '%';
            
            if (indicators.bestMonth) {
                var parts = indicators.bestMonth.split('-');
                var monthNames = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                document.getElementById('progressBestMonth').textContent = monthNames[parseInt(parts[1]) - 1] + '/' + parts[0].slice(2);
            }
        }

        // Carregar Lembretes (sess√µes de amanh√£)
        function loadReminders() {
            var tomorrowSessions = TheraFlowData.getTomorrowSessions();
            var reminderSection = document.getElementById('reminderSection');
            
            if (tomorrowSessions.length === 0) {
                reminderSection.innerHTML = '';
                return;
            }
            
            var sessionsHtml = tomorrowSessions.map(function(s) {
                return '<div class="reminder-session">' +
                    '<div class="info">' +
                        '<strong>' + s.hora + '</strong> - ' + s.clienteNome + '<br>' +
                        '<small>' + s.tipo + '</small>' +
                    '</div>' +
                    '<div class="actions">' +
                        '<button class="btn btn-confirm" onclick="confirmSession(' + s.id + ')">‚úì Confirmar</button>' +
                        '<button class="btn btn-reschedule" onclick="rescheduleSession(' + s.id + ')">üìÖ</button>' +
                    '</div>' +
                '</div>';
            }).join('');
            
            reminderSection.innerHTML = 
                '<div class="reminder-card">' +
                    '<h3>üîî Sess√µes Amanh√£ √†s 18h</h3>' +
                    sessionsHtml +
                '</div>';
        }

        function confirmSession(id) {
            TheraFlowData.updateSession(id, { status: 'confirmado', confirmadoPeloCliente: true });
            TheraFlowUI.toast('Sess√£o confirmada!', 'success');
            loadReminders();
        }

        function rescheduleSession(id) {
            var session = TheraFlowData.getSessionById(id);
            if (!session) return;
            
            var content = 
                '<div style="text-align: center; padding: 10px;">' +
                    '<p style="margin-bottom: 20px;">Reagendar sess√£o de <strong>' + session.clienteNome + '</strong></p>' +
                    '<div class="tf-form-group">' +
                        '<label>Nova Data</label>' +
                        '<input type="date" id="newDate" value="' + session.data + '">' +
                    '</div>' +
                    '<div class="tf-form-group">' +
                        '<label>Novo Hor√°rio</label>' +
                        '<input type="time" id="newTime" value="' + session.hora + '">' +
                    '</div>' +
                '</div>';
            
            TheraFlowUI.showModal({
                title: 'üìÖ Reagendar Sess√£o',
                content: content,
                buttons: [
                    { text: 'Cancelar', onClick: function() { TheraFlowUI.closeModal(); } },
                    { text: 'Reagendar', primary: true, onClick: function() {
                        var newDate = document.getElementById('newDate').value;
                        var newTime = document.getElementById('newTime').value;
                        TheraFlowData.updateSession(id, { data: newDate, hora: newTime });
                        TheraFlowUI.closeModal();
                        TheraFlowUI.toast('Sess√£o reagendada!', 'success');
                        loadReminders();
                        loadSessions();
                    }}
                ]
            });
        }
    </script>
</body>
</html>
